{"version":3,"file":"inject_guide.min.js","sources":["../../src/inject_ai/inject_guide.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Injects assessment guide grades and comments.\n *\n * @module      local_assign_ai/inject_ai/inject_guide\n * @copyright   2025 Datacurso\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport { normalizeString } from './normalize_string';\n\n/**\n * Injects assessment guide grades and comments.\n *\n * @param {Object} guideData The guide data object.\n * @param {{root?: Element|Document}} options Injection options.\n * @returns {boolean} True if guide was injected successfully.\n */\nexport const injectGuide = (guideData, options = {}) => {\n    const root = options.root || document;\n    const targetUserid = options.targetUserid ? parseInt(options.targetUserid, 10) : 0;\n    let injected = false;\n\n    Object.keys(guideData).forEach(criterionName => {\n        const data = guideData[criterionName];\n        if (!data) {\n            return;\n        }\n\n        const grade = data.grade;\n        let comments = data.reply;\n        if (Array.isArray(comments)) {\n            comments = comments.join(', ');\n        }\n\n        const allrows = Array.from(root.querySelectorAll('tr')).filter((row) => {\n            if (!targetUserid) {\n                return true;\n            }\n            const form = row.closest('form');\n            if (!form) {\n                return true;\n            }\n            const userinput = form.querySelector('input[name=\"userid\"]');\n            if (!userinput) {\n                return true;\n            }\n            return parseInt(userinput.value, 10) === targetUserid;\n        }); // Broad search for criteria rows\n        const visiblerows = allrows.filter(row => row.offsetParent !== null || row.getClientRects().length > 0);\n        const rows = visiblerows.length ? visiblerows : allrows;\n        rows.forEach(row => {\n            if (!normalizeString(row.textContent).includes(normalizeString(criterionName))) {\n                return;\n            }\n\n            const scoreInput = row.querySelector('.score input[type=\"text\"]');\n            const remarkTextarea = row.querySelector('.remark textarea');\n            let rowUpdated = false;\n\n            if (scoreInput && grade !== undefined && grade !== null) {\n                if (scoreInput.value != grade) {\n                    scoreInput.value = grade;\n                    scoreInput.dispatchEvent(new Event('change', { bubbles: true }));\n                }\n                rowUpdated = true;\n            }\n\n            if (remarkTextarea && comments) {\n                if (remarkTextarea.value !== comments) {\n                    remarkTextarea.value = comments;\n                    remarkTextarea.dispatchEvent(new Event('input', { bubbles: true }));\n                    remarkTextarea.dispatchEvent(new Event('change', { bubbles: true }));\n                }\n                rowUpdated = true;\n            }\n\n            if (rowUpdated) {\n                injected = true;\n            }\n        });\n    });\n\n    return injected;\n};\n"],"names":["guideData","options","root","document","targetUserid","parseInt","injected","Object","keys","forEach","criterionName","data","grade","comments","reply","Array","isArray","join","allrows","from","querySelectorAll","filter","row","form","closest","userinput","querySelector","value","visiblerows","offsetParent","getClientRects","length","textContent","includes","scoreInput","remarkTextarea","rowUpdated","dispatchEvent","Event","bubbles"],"mappings":"gOAgC2B,SAACA,eAAWC,+DAAU,SACvCC,KAAOD,QAAQC,MAAQC,SACvBC,aAAeH,QAAQG,aAAeC,SAASJ,QAAQG,aAAc,IAAM,MAC7EE,UAAW,SAEfC,OAAOC,KAAKR,WAAWS,SAAQC,sBACrBC,KAAOX,UAAUU,mBAClBC,kBAICC,MAAQD,KAAKC,UACfC,SAAWF,KAAKG,MAChBC,MAAMC,QAAQH,YACdA,SAAWA,SAASI,KAAK,aAGvBC,QAAUH,MAAMI,KAAKjB,KAAKkB,iBAAiB,OAAOC,QAAQC,UACvDlB,oBACM,QAELmB,KAAOD,IAAIE,QAAQ,YACpBD,YACM,QAELE,UAAYF,KAAKG,cAAc,+BAChCD,WAGEpB,SAASoB,UAAUE,MAAO,MAAQvB,gBAEvCwB,YAAcV,QAAQG,QAAOC,KAA4B,OAArBA,IAAIO,cAAyBP,IAAIQ,iBAAiBC,OAAS,KACxFH,YAAYG,OAASH,YAAcV,SAC3CT,SAAQa,WACJ,qCAAgBA,IAAIU,aAAaC,UAAS,qCAAgBvB,6BAIzDwB,WAAaZ,IAAII,cAAc,6BAC/BS,eAAiBb,IAAII,cAAc,wBACrCU,YAAa,EAEbF,YAAAA,MAActB,QACVsB,WAAWP,OAASf,QACpBsB,WAAWP,MAAQf,MACnBsB,WAAWG,cAAc,IAAIC,MAAM,SAAU,CAAEC,SAAS,MAE5DH,YAAa,GAGbD,gBAAkBtB,WACdsB,eAAeR,QAAUd,WACzBsB,eAAeR,MAAQd,SACvBsB,eAAeE,cAAc,IAAIC,MAAM,QAAS,CAAEC,SAAS,KAC3DJ,eAAeE,cAAc,IAAIC,MAAM,SAAU,CAAEC,SAAS,MAEhEH,YAAa,GAGbA,aACA9B,UAAW,SAKhBA"}