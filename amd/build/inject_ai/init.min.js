define("local_assign_ai/inject_ai/init",["exports","core/ajax","core/notification","core/str","./inject_message","./inject_rubric","./inject_guide","./inject_simple_grade","./normalize_string"],(function(_exports,_ajax,_notification,_str,_inject_message,_inject_rubric,_inject_guide,_inject_simple_grade,_normalize_string){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Fetches AI data and injects it into grading forms.
   *
   * @module      local_assign_ai/inject_ai/init
   * @copyright   2025 Datacurso
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification);let activerunid=0,activecleanup=null;_exports.init=async _ref3=>{let{userid:userid,assignmentid:assignmentid,courseid:courseid}=_ref3;if(!userid||!assignmentid||!courseid)return;activecleanup&&activecleanup();const runid=++activerunid;let intervalid=0,observer=null,finished=!1,successNotified=!1,stableSuccessCount=0,attempts=0;const isCurrentRun=()=>runid===activerunid,cleanup=()=>{finished||(finished=!0,intervalid&&(clearInterval(intervalid),intervalid=0),observer&&(observer.disconnect(),observer=null))};activecleanup=cleanup;const[strRubricArray,strRubricSuccess]=await Promise.all([(0,_str.get_string)("rubricmustarray","local_assign_ai"),(0,_str.get_string)("rubricsuccess","local_assign_ai")]);if(!isCurrentRun())return;let cachedData=null,fetchcounter=0;const tryInjection=()=>{if(!isCurrentRun()||finished||!cachedData)return;let parsed;try{parsed=(data=>{var _ref,_data$message,_ref2,_data$rubric_response,_data$assessment_guid,_data$grade,_data$status;const message=null!==(_ref=null!==(_data$message=data.message)&&void 0!==_data$message?_data$message:data.reply)&&void 0!==_ref?_ref:"",rubricResponse=null!==(_ref2=null!==(_data$rubric_response=data.rubric_response)&&void 0!==_data$rubric_response?_data$rubric_response:data.rubric)&&void 0!==_ref2?_ref2:null,guideResponse=null!==(_data$assessment_guid=data.assessment_guide_response)&&void 0!==_data$assessment_guid?_data$assessment_guid:null,grade=null!==(_data$grade=data.grade)&&void 0!==_data$grade?_data$grade:null,status=null!==(_data$status=data.status)&&void 0!==_data$status?_data$status:"none";if(guideResponse&&"null"!==guideResponse&&""!==guideResponse)return{status:status,message:message,mode:"guide",payload:"string"==typeof guideResponse?JSON.parse(guideResponse):guideResponse,grade:grade};if(rubricResponse&&"null"!==rubricResponse&&""!==rubricResponse){const parsed="string"==typeof rubricResponse?JSON.parse(rubricResponse):rubricResponse;return{status:status,message:message,mode:Array.isArray(parsed)||"object"!=typeof parsed?"rubric":"guide",payload:parsed,grade:grade}}return null!=grade?{status:status,message:message,mode:"simple",payload:null,grade:grade}:{status:status,message:message,mode:"none",payload:null,grade:grade}})(cachedData)}catch(e){return void cleanup()}if("approve"===parsed.status)return void cleanup();const rootInfo=(()=>{const selectors=["#fitem_id_advancedgrading .gradingform_rubric","#fitem_id_advancedgrading .gradingform_guide",".gradingform_rubric.evaluate.editable",".gradingform_guide.evaluate.editable",".gradingform_rubric",".gradingform_guide"];for(const selector of selectors){const nodes=Array.from(document.querySelectorAll(selector)),visible=nodes.find((node=>null!==node.offsetParent||node.getClientRects().length>0));if(visible)return{root:visible,selector:selector,visible:!0,candidates:nodes.length};if(nodes.length)return{root:nodes[0],selector:selector,visible:!1,candidates:nodes.length}}return{root:document,selector:"document",visible:!1,candidates:0}})(),gradingRoot=rootInfo.root,hasRubricRows=gradingRoot.querySelectorAll("tr.criterion").length>0;if("rubric"===parsed.mode&&!rootInfo.visible)return;if("rubric"===parsed.mode&&!hasRubricRows)return;(0,_inject_message.injectMessage)(parsed.message);let applied=!1;if("guide"===parsed.mode)applied=(0,_inject_guide.injectGuide)(parsed.payload,{root:gradingRoot});else if("rubric"===parsed.mode){applied=!!(0,_inject_rubric.injectRubric)(parsed.payload,strRubricArray,{detailed:!0,root:gradingRoot}).injected;((rubricData,root)=>{if(!Array.isArray(rubricData))return{ok:!1,mismatches:[{reason:"rubric_data_not_array"}]};const rows=Array.from(root.querySelectorAll("tr.criterion")),mismatches=[];return rubricData.forEach((criterionData=>{var _criterionData$levels,_criterionData$levels2,_criterionData$levels3;const name=(null==criterionData?void 0:criterionData.criterion)||"",expected=parseFloat(null!==(_criterionData$levels=null==criterionData||null===(_criterionData$levels2=criterionData.levels)||void 0===_criterionData$levels2||null===(_criterionData$levels3=_criterionData$levels2[0])||void 0===_criterionData$levels3?void 0:_criterionData$levels3.points)&&void 0!==_criterionData$levels?_criterionData$levels:""),row=rows.find((rowItem=>{const cell=rowItem.querySelector("td.description");return!!cell&&(0,_normalize_string.normalizeString)(cell.textContent.trim())===(0,_normalize_string.normalizeString)(name.trim())}));if(!row)return void mismatches.push({criterion:name,reason:"row_not_found",expected:expected});let selected=null;Array.from(row.querySelectorAll("td.level")).forEach((levelCell=>{const radio=levelCell.querySelector('input[type="radio"]');if(!(null!=radio&&radio.checked||levelCell.classList.contains("checked")||"true"===levelCell.getAttribute("aria-checked")))return;const score=levelCell.querySelector(".scorevalue");score&&(selected=parseFloat(score.textContent.trim()))})),null!==selected?Math.abs(selected-expected)>=.1&&mismatches.push({criterion:name,reason:"points_mismatch",expected:expected,selected:selected}):mismatches.push({criterion:name,reason:"no_level_selected",expected:expected})})),{ok:0===mismatches.length,mismatches:mismatches}})(parsed.payload,gradingRoot).ok||(applied=!1)}else"simple"===parsed.mode&&(applied=(0,_inject_simple_grade.injectSimpleGrade)(parsed.grade));applied?(stableSuccessCount++,!successNotified&&stableSuccessCount>=2&&(_notification.default.addNotification({message:strRubricSuccess,type:"success"}),successNotified=!0,setTimeout((()=>{isCurrentRun()&&cleanup()}),500))):stableSuccessCount=0},refreshAndInject=async()=>{if(isCurrentRun()&&!finished){if(fetchcounter++,!cachedData||fetchcounter%4==0)try{if(cachedData=await(async()=>_ajax.default.call([{methodname:"local_assign_ai_get_details",args:{courseid:courseid,cmid:assignmentid,userid:userid}}])[0])(),!isCurrentRun()||finished)return}catch(e){return _notification.default.exception(e),void cleanup()}tryInjection()}};if(await refreshAndInject(),!isCurrentRun()||finished)return;intervalid=setInterval((()=>{attempts++,attempts>320?cleanup():refreshAndInject()}),250);const container=document.querySelector("#fitem_id_advancedgrading")||document.querySelector('[data-region="grading-actions-form"]')||document.body;observer=new MutationObserver((()=>{isCurrentRun()&&!finished&&tryInjection()})),observer.observe(container,{childList:!0,subtree:!0}),setTimeout((()=>{isCurrentRun()&&cleanup()}),9e4)}}));

//# sourceMappingURL=init.min.js.map