define("local_assign_ai/inject_ai/init",["exports","core/ajax","core/notification","core/str","core/log","./inject_message","./inject_rubric","./inject_guide","./inject_simple_grade"],(function(_exports,_ajax,_notification,_str,_log,_inject_message,_inject_rubric,_inject_guide,_inject_simple_grade){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Fetches AI data and injects it into grading forms.
   *
   * @module      local_assign_ai/inject_ai/init
   * @copyright   2025 Datacurso
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification),_log=_interopRequireDefault(_log);_exports.init=async _ref=>{let{token:token,userid:userid,assignmentid:assignmentid,courseid:courseid}=_ref;if(!(token&&userid&&assignmentid&&courseid))return;const[strErrorParsing,strRubricArray,strRubricSuccess,strRubricFailed]=await Promise.all([(0,_str.get_string)("errorparsingrubric","local_assign_ai"),(0,_str.get_string)("rubricmustarray","local_assign_ai"),(0,_str.get_string)("rubricsuccess","local_assign_ai"),(0,_str.get_string)("rubricfailed","local_assign_ai")]);_ajax.default.call([{methodname:"local_assign_ai_get_details",args:{courseid:courseid,cmid:assignmentid,userid:userid}}])[0].done((data=>{var _ref2,_data$message,_ref3,_data$rubric_response,_data$assessment_guid,_data$grade,_data$status;const message=null!==(_ref2=null!==(_data$message=data.message)&&void 0!==_data$message?_data$message:data.reply)&&void 0!==_ref2?_ref2:"",rubricResponse=null!==(_ref3=null!==(_data$rubric_response=data.rubric_response)&&void 0!==_data$rubric_response?_data$rubric_response:data.rubric)&&void 0!==_ref3?_ref3:null,guideResponse=null!==(_data$assessment_guid=data.assessment_guide_response)&&void 0!==_data$assessment_guid?_data$assessment_guid:null,grade=null!==(_data$grade=data.grade)&&void 0!==_data$grade?_data$grade:null,status=null!==(_data$status=data.status)&&void 0!==_data$status?_data$status:"none";if(_log.default.debug("[local_assign_ai] Data received:",{reference:message,rubricResponse:rubricResponse,guideResponse:guideResponse,grade:grade}),"approve"===status)return void _log.default.debug("[local_assign_ai] Skipping injection for approved status.");let successfulInjection=!1;const runInjection=()=>{let anyInjected=!1;(0,_inject_message.injectMessage)(message);let advancedData=null,isGuide=!1;if(guideResponse&&"null"!==guideResponse&&""!==guideResponse)try{advancedData="string"==typeof guideResponse?JSON.parse(guideResponse):guideResponse,isGuide=!0}catch(e){return _log.default.error("[local_assign_ai] Error parsing guide:",e),_notification.default.addNotification({message:"".concat(strErrorParsing," ").concat(e.message),type:"error"}),!1}else if(rubricResponse&&"null"!==rubricResponse&&""!==rubricResponse)try{advancedData="string"==typeof rubricResponse?JSON.parse(rubricResponse):rubricResponse,Array.isArray(advancedData)||"object"!=typeof advancedData||(isGuide=!0)}catch(e){return _log.default.error("[local_assign_ai] Error parsing rubric:",e),_notification.default.addNotification({message:"".concat(strErrorParsing," ").concat(e.message),type:"error"}),!1}return advancedData?isGuide?(0,_inject_guide.injectGuide)(advancedData)&&(anyInjected=!0):Array.isArray(advancedData)&&(0,_inject_rubric.injectRubric)(advancedData,strRubricArray)&&(anyInjected=!0):(0,_inject_simple_grade.injectSimpleGrade)(grade)&&(anyInjected=!0),anyInjected};let attempts=0;const interval=setInterval((()=>{var success;attempts++,successfulInjection||runInjection()&&(successfulInjection=!0),(successfulInjection&&attempts>20||attempts>100)&&(clearInterval(interval),successfulInjection&&(success=!0,_notification.default.addNotification({message:success?strRubricSuccess:strRubricFailed,type:success?"success":"warning"})))}),300),container=document.querySelector('[data-region="grading-actions-form"]')||document.querySelector(".gradingform_rubric")||document.querySelector(".gradingform_guide")||document.body;if(container){const observer=new MutationObserver((()=>{document.querySelectorAll("tr.criterion, .gradingform_guide tr").length>0&&!successfulInjection&&runInjection()&&(successfulInjection=!0,observer.disconnect())}));observer.observe(container,{childList:!0,subtree:!0}),setTimeout((()=>observer.disconnect()),2e4)}})).fail(_notification.default.exception)}}));

//# sourceMappingURL=init.min.js.map