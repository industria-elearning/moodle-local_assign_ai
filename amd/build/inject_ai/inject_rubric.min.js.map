{"version":3,"file":"inject_rubric.min.js","sources":["../../src/inject_ai/inject_rubric.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Injects rubric selections and comments.\n *\n * @module      local_assign_ai/inject_ai/inject_rubric\n * @copyright   2025 Datacurso\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Notification from 'core/notification';\nimport { normalizeString } from './normalize_string';\n\n/**\n * Injects rubric selections and comments.\n *\n * @param {Array} rubricData The rubric data array.\n * @param {string} strRubricError Error string for validation.\n * @returns {boolean} True if rubric was injected successfully\n */\nexport const injectRubric = (rubricData, strRubricError) => {\n    if (!Array.isArray(rubricData)) {\n        Notification.addNotification({\n            message: strRubricError,\n            type: 'error'\n        });\n        return false;\n    }\n\n    let injected = false;\n    const criterionRows = document.querySelectorAll('tr.criterion');\n\n    if (criterionRows.length === 0) {\n        return false;\n    }\n\n    rubricData.forEach((criterionData) => {\n        const criterionName = criterionData.criterion;\n        const targetPoints = criterionData.levels[0].points;\n        const comment = criterionData.levels[0].comment;\n\n        criterionRows.forEach((row) => {\n            const descriptionCell = row.querySelector('td.description');\n            if (!descriptionCell) {\n                return;\n            }\n\n            const rowCriterionName = descriptionCell.textContent.trim();\n            if (normalizeString(rowCriterionName) !== normalizeString(criterionName)) {\n                return;\n            }\n\n            const levelCells = row.querySelectorAll('td.level');\n            levelCells.forEach((levelCell) => {\n                const scoreSpan = levelCell.querySelector('.scorevalue');\n                if (!scoreSpan) {\n                    return;\n                }\n\n                const points = parseFloat(scoreSpan.textContent.trim());\n\n                if (Math.abs(points - targetPoints) < 0.1) {\n                    const radioInput = levelCell.querySelector('input[type=\"radio\"]');\n                    if (!radioInput) {\n                        return;\n                    }\n\n                    if (radioInput.checked) {\n                        injected = true;\n                    } else {\n                        if (levelCell.click) {\n                            levelCell.click();\n                        }\n                        if (radioInput.click) {\n                            radioInput.click();\n                        }\n\n                        setTimeout(() => {\n                            radioInput.checked = true;\n                            radioInput.dispatchEvent(new Event('change', { bubbles: true }));\n                            levelCell.setAttribute('aria-checked', 'true');\n                            levelCell.parentElement.querySelectorAll('td.level').forEach(c => {\n                                if (c !== levelCell) {\n                                    c.setAttribute('aria-checked', 'false');\n                                }\n                            });\n                        }, 50);\n                        injected = true;\n                    }\n                }\n            });\n\n            const remarkTextarea = row.querySelector('td.remark textarea');\n            if (remarkTextarea && comment) {\n                if (remarkTextarea.value !== comment) {\n                    remarkTextarea.value = comment;\n                    remarkTextarea.dispatchEvent(new Event('input', { bubbles: true }));\n                    remarkTextarea.dispatchEvent(new Event('change', { bubbles: true }));\n                }\n                injected = true;\n            }\n        });\n    });\n\n    return injected;\n};\n"],"names":["rubricData","strRubricError","Array","isArray","addNotification","message","type","injected","criterionRows","document","querySelectorAll","length","forEach","criterionData","criterionName","criterion","targetPoints","levels","points","comment","row","descriptionCell","querySelector","rowCriterionName","textContent","trim","levelCell","scoreSpan","parseFloat","Math","abs","radioInput","checked","click","setTimeout","dispatchEvent","Event","bubbles","setAttribute","parentElement","c","remarkTextarea","value"],"mappings":";;;;;;;oLAiC4B,CAACA,WAAYC,sBAChCC,MAAMC,QAAQH,yCACFI,gBAAgB,CACzBC,QAASJ,eACTK,KAAM,WAEH,MAGPC,UAAW,QACTC,cAAgBC,SAASC,iBAAiB,uBAEnB,IAAzBF,cAAcG,SAIlBX,WAAWY,SAASC,sBACVC,cAAgBD,cAAcE,UAC9BC,aAAeH,cAAcI,OAAO,GAAGC,OACvCC,QAAUN,cAAcI,OAAO,GAAGE,QAExCX,cAAcI,SAASQ,YACbC,gBAAkBD,IAAIE,cAAc,sBACrCD,6BAICE,iBAAmBF,gBAAgBG,YAAYC,WACjD,qCAAgBF,qBAAsB,qCAAgBT,sBAIvCM,IAAIV,iBAAiB,YAC7BE,SAASc,kBACVC,UAAYD,UAAUJ,cAAc,mBACrCK,uBAICT,OAASU,WAAWD,UAAUH,YAAYC,WAE5CI,KAAKC,IAAIZ,OAASF,cAAgB,GAAK,OACjCe,WAAaL,UAAUJ,cAAc,2BACtCS,kBAIDA,WAAWC,UAGPN,UAAUO,OACVP,UAAUO,QAEVF,WAAWE,OACXF,WAAWE,QAGfC,YAAW,KACPH,WAAWC,SAAU,EACrBD,WAAWI,cAAc,IAAIC,MAAM,SAAU,CAAEC,SAAS,KACxDX,UAAUY,aAAa,eAAgB,QACvCZ,UAAUa,cAAc7B,iBAAiB,YAAYE,SAAQ4B,IACrDA,IAAMd,WACNc,EAAEF,aAAa,eAAgB,cAGxC,KAlBH/B,UAAW,YAwBjBkC,eAAiBrB,IAAIE,cAAc,sBACrCmB,gBAAkBtB,UACdsB,eAAeC,QAAUvB,UACzBsB,eAAeC,MAAQvB,QACvBsB,eAAeN,cAAc,IAAIC,MAAM,QAAS,CAAEC,SAAS,KAC3DI,eAAeN,cAAc,IAAIC,MAAM,SAAU,CAAEC,SAAS,MAEhE9B,UAAW,SAKhBA"}