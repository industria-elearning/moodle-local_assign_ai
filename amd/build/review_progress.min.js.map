{"version":3,"file":"review_progress.min.js","sources":["../src/review_progress.js"],"sourcesContent":["/* eslint-disable */\n// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Polls backend for progress of AI reviews and updates UI accordingly.\n *\n * @module     local_assign_ai/review_progress\n * @copyright  2025 Wilber Narvaez <https://datacurso.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\n\nconst POLL_MS_DEFAULT = 8000;\nlet intervalid = 0;\n\n// Client-side smoothing state per row. We keep randomized parameters per processing session\n// so that progress does not look identical across rows or sessions.\nconst startTimes = new Map(); // pendingid -> timestamp ms\nconst expectedDurations = new Map(); // pendingid -> ms\nconst startOffsets = new Map(); // pendingid -> int percent (1..8)\nconst curveFactors = new Map(); // pendingid -> float (0.6..1.4)\nconst lastShown = new Map(); // pendingid -> last integer percent shown\n\n/**\n * Disable/enable the header buttons depending on current progress state.\n */\nfunction reflectHeaderButtonsState() {\n    const anyInProgress = document.querySelector('tr.js-row-inprogress');\n    const btnReviewAll = document.querySelector('.js-review-all');\n    const btnApproveAll = document.querySelector('.js-approve-all');\n\n    if (btnReviewAll) {\n        btnReviewAll.disabled = !!anyInProgress || btnReviewAll.disabled;\n    }\n    if (btnApproveAll) {\n        if (anyInProgress) {\n            btnApproveAll.setAttribute('disabled', 'disabled');\n        } else if (btnApproveAll.dataset.enableonidle === '1') {\n            btnApproveAll.removeAttribute('disabled');\n        }\n    }\n}\n\n/**\n * Update a single row UI using progress info.\n * @param {HTMLElement} row\n * @param {number} progress\n * @param {string} status\n */\nfunction updateRow(row, progress, status) {\n    const badge = row.querySelector('.js-state-badge');\n    const hint = row.querySelector('.js-state-hint');\n    let indicator = row.querySelector('.js-progress-indicator');\n    const btnReview = row.querySelector('.js-btn-review');\n    const btnDetails = row.querySelector('.js-btn-details');\n\n    if (status === 'processing' && progress > 0 && progress < 100) {\n        row.classList.add('js-row-inprogress');\n        if (!indicator) {\n            indicator = document.createElement('div');\n            indicator.className = 'small text-warning js-progress-indicator';\n            indicator.innerHTML = '<span class=\"spinner-border spinner-border-sm me-1\" role=\"status\" aria-hidden=\"true\"></span>';\n            row.querySelector('td:nth-child(7)')?.appendChild(indicator);\n        }\n        getString('processing', 'local_assign_ai').then(txt => {\n            indicator.innerHTML = '<span class=\"spinner-border spinner-border-sm me-1\" role=\"status\" aria-hidden=\"true\"></span>' + txt + ' (' + progress + '%)';\n        }).catch(() => {});\n\n        // Disable row action buttons while in progress.\n        row.querySelectorAll('button').forEach(b => b.setAttribute('disabled', 'disabled'));\n    } else {\n        row.classList.remove('js-row-inprogress');\n        if (indicator) {\n            indicator.remove();\n        }\n        // Re-enable row buttons depending on status.\n        if (status === 'initial') {\n            row.querySelectorAll('.js-review-ai').forEach(b => b.removeAttribute('disabled'));\n        } else if (status === 'pending') {\n            row.querySelectorAll('.view-details').forEach(b => b.removeAttribute('disabled'));\n        } else if (status === 'queued') {\n            // Keep disabled while waiting for processing to start.\n            row.querySelectorAll('button').forEach(b => b.setAttribute('disabled', 'disabled'));\n        } else {\n            row.querySelectorAll('button').forEach(b => b.removeAttribute('disabled'));\n        }\n    }\n\n    if (badge && hint) {\n        // Update badge class and short text per status, and the longer hint below.\n        if (status === 'initial') {\n            badge.className = 'badge bg-secondary js-state-badge';\n            getString('aistatus_initial_short', 'local_assign_ai').then(t => { badge.textContent = t; }).catch(() => {});\n            getString('aistatus_initial_help', 'local_assign_ai').then(t => { hint.textContent = t; }).catch(() => {});\n        } else if (status === 'queued') {\n            badge.className = 'badge bg-warning text-dark js-state-badge';\n            getString('queued', 'local_assign_ai').then(t => { badge.textContent = t; }).catch(() => {});\n            getString('aistatus_queued_help', 'local_assign_ai').then(t => { hint.textContent = t; }).catch(() => {});\n        } else if (status === 'processing') {\n            badge.className = 'badge bg-warning text-dark js-state-badge';\n            getString('processing', 'local_assign_ai').then(t => { badge.textContent = t; }).catch(() => {});\n            getString('aistatus_processing_help', 'local_assign_ai').then(t => { hint.textContent = t; }).catch(() => {});\n        } else if (status === 'pending') {\n            badge.className = 'badge bg-info js-state-badge';\n            getString('aistatus_pending_short', 'local_assign_ai').then(t => { badge.textContent = t; }).catch(() => {});\n            getString('aistatus_pending_help', 'local_assign_ai').then(t => { hint.textContent = t; }).catch(() => {});\n        }\n    }\n\n    // Toggle visibility of action buttons based on status.\n    if (btnReview && btnDetails) {\n        if (status === 'pending' || progress >= 100) {\n            btnReview.classList.add('d-none');\n            btnDetails.classList.remove('d-none');\n        } else if (status === 'initial' || status === 'queued' || status === 'processing') {\n            btnDetails.classList.add('d-none');\n            btnReview.classList.remove('d-none');\n        }\n    }\n}\n\n/**\n * Find pending ids in the table that need updates.\n * @returns {number[]}\n */\nfunction collectPendingIds() {\n    const rows = document.querySelectorAll('tr[data-pendingid]');\n    const ids = [];\n    rows.forEach(row => {\n        const pid = parseInt(row.getAttribute('data-pendingid'), 10);\n        const progress = parseInt(row.getAttribute('data-progress') || '0', 10);\n        if (pid && progress < 100) {\n            ids.push(pid);\n        }\n    });\n    return ids;\n}\n\n/**\n * Apply returned progress values to DOM.\n * @param {Array} entries\n */\nfunction applyProgress(entries) {\n    const now = Date.now();\n    entries.forEach(entry => {\n        const row = document.querySelector('tr[data-pendingid=\"' + entry.id + '\"]');\n        if (!row) {\n            return;\n        }\n        // Initialize smoothing when processing begins and it's not tracked.\n        if (entry.status === 'processing') {\n            if (!startTimes.has(entry.id)) {\n                startTimes.set(entry.id, now);\n                // Randomize expected duration 20-55s.\n                const expected = 20000 + Math.floor(Math.random() * 35001);\n                expectedDurations.set(entry.id, expected);\n                // Randomize starting offset 1-8% to avoid uniform starts.\n                startOffsets.set(entry.id, 1 + Math.floor(Math.random() * 8));\n                // Randomize easing curve factor for diversity (ease-out exponent).\n                curveFactors.set(entry.id, 0.6 + Math.random() * 0.8); // 0.6..1.4\n                // Initialize last shown.\n                lastShown.set(entry.id, 0);\n            }\n        }\n\n        // Compute adjusted client-side progress.\n        let adjusted = 0;\n        if (entry.status === 'processing' && startTimes.has(entry.id)) {\n            const startedAt = startTimes.get(entry.id);\n            const expected = expectedDurations.get(entry.id) || 35000;\n            const elapsed = Math.max(0, now - startedAt);\n            const t = Math.min(0.999, Math.max(0, elapsed / expected));\n            const start = startOffsets.get(entry.id) || 1;\n            const curve = curveFactors.get(entry.id) || 1.0;\n            // Ease-out with variable exponent to diversify curves.\n            const eased = 1 - Math.pow(1 - t, curve);\n            let estimated = start + Math.floor(eased * (99 - start));\n            // Add small, bounded per-tick noise to avoid perfectly smooth growth.\n            const noise = Math.floor((Math.random() * 5) - 2); // -2..+2\n            estimated = Math.max(start, Math.min(99, estimated + noise));\n            // Ensure monotonic increase.\n            const last = lastShown.get(entry.id) || 0;\n            adjusted = Math.max(last, estimated);\n            lastShown.set(entry.id, adjusted);\n        }\n\n        // If status is no longer processing, clear smoothing state.\n        if (entry.status !== 'processing') {\n            startTimes.delete(entry.id);\n            expectedDurations.delete(entry.id);\n            startOffsets.delete(entry.id);\n            curveFactors.delete(entry.id);\n            lastShown.delete(entry.id);\n        }\n\n        row.setAttribute('data-progress', String(adjusted));\n        updateRow(row, adjusted, entry.status);\n    });\n\n    reflectHeaderButtonsState();\n}\n\n/**\n * Poll backend for progress.\n */\nfunction poll() {\n    const ids = collectPendingIds();\n    if (ids.length === 0) {\n        clearInterval(intervalid);\n        reflectHeaderButtonsState();\n        return;\n    }\n\n    Ajax.call([{\n        methodname: 'local_assign_ai_get_progress',\n        args: { pendingids: ids },\n    }])[0].done(result => {\n        applyProgress(result);\n    }).fail(err => {\n        Notification.exception(err);\n    });\n}\n\n/**\n * Init module.\n * @param {number} cmid\n */\nexport function init(cmid) {\n    // Initial reflect and start polling.\n    reflectHeaderButtonsState();\n    // If page was just queued, ensure we start immediately.\n    const initialDelay = document.body.classList.contains('assign-ai-progress-running') ? 0 : POLL_MS_DEFAULT;\n    setTimeout(() => {\n        poll();\n        intervalid = setInterval(poll, POLL_MS_DEFAULT);\n    }, initialDelay);\n}\n"],"names":["cmid","reflectHeaderButtonsState","initialDelay","document","body","classList","contains","setTimeout","poll","intervalid","setInterval","startTimes","Map","expectedDurations","startOffsets","curveFactors","lastShown","anyInProgress","querySelector","btnReviewAll","btnApproveAll","disabled","setAttribute","dataset","enableonidle","removeAttribute","applyProgress","entries","now","Date","forEach","entry","row","id","status","has","set","expected","Math","floor","random","adjusted","startedAt","get","elapsed","max","t","min","start","curve","eased","pow","estimated","noise","last","delete","String","progress","badge","hint","indicator","btnReview","btnDetails","add","createElement","className","innerHTML","appendChild","then","txt","catch","querySelectorAll","b","remove","textContent","updateRow","ids","rows","pid","parseInt","getAttribute","push","collectPendingIds","length","clearInterval","call","methodname","args","pendingids","done","result","fail","err","exception"],"mappings":"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"}