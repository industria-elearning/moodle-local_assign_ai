{"version":3,"file":"review_progress.min.js","sources":["../src/review_progress.js"],"sourcesContent":["/* eslint-disable */\n// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Polls backend for progress of AI reviews and updates UI accordingly.\n *\n * @module     local_assign_ai/review_progress\n * @copyright  2025 Wilber Narvaez <https://datacurso.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\n\nconst POLL_MS_DEFAULT = 8000;\nlet intervalid = 0;\n\n// Client-side smoothing state per row. We keep randomized parameters per processing session\n// so that progress does not look identical across rows or sessions.\nconst startTimes = new Map(); // pendingid -> timestamp ms\nconst expectedDurations = new Map(); // pendingid -> ms\nconst startOffsets = new Map(); // pendingid -> int percent (1..8)\nconst curveFactors = new Map(); // pendingid -> float (0.6..1.4)\nconst lastShown = new Map(); // pendingid -> last integer percent shown\n\nfunction setLinkDisabled(link, disabled) {\n    if (!link) {\n        return;\n    }\n    if (disabled) {\n        link.classList.add('disabled');\n        link.setAttribute('aria-disabled', 'true');\n        link.setAttribute('tabindex', '-1');\n    } else {\n        link.classList.remove('disabled');\n        link.removeAttribute('aria-disabled');\n        link.removeAttribute('tabindex');\n    }\n}\n\n/**\n * Check if there are rows that should be polled.\n * @returns {boolean}\n */\nfunction hasActiveRows() {\n    return !!document.querySelector('tr[data-status=\"processing\"], tr[data-status=\"queued\"], tr.js-row-inprogress, tr.js-row-queued');\n}\n\n/**\n * Disable/enable the header buttons depending on current progress state.\n */\nfunction reflectHeaderButtonsState() {\n    const anyActive = hasActiveRows();\n    const btnReviewAll = document.querySelector('.js-review-all');\n    const btnApproveAll = document.querySelector('.js-approve-all');\n\n    if (btnReviewAll) {\n        btnReviewAll.disabled = anyActive || btnReviewAll.disabled;\n    }\n    if (btnApproveAll) {\n        if (anyActive) {\n            btnApproveAll.setAttribute('disabled', 'disabled');\n        } else if (btnApproveAll.dataset.enableonidle === '1') {\n            btnApproveAll.removeAttribute('disabled');\n        }\n    }\n}\n\n/**\n * Update a single row UI using progress info.\n * @param {HTMLElement} row\n * @param {number} progress\n * @param {string} status\n */\nfunction updateRow(row, progress, status) {\n    const badge = row.querySelector('.js-state-badge');\n    const hint = row.querySelector('.js-state-hint');\n    let indicator = row.querySelector('.js-progress-indicator');\n    const btnReview = row.querySelector('.js-btn-review');\n    const btnDetails = row.querySelector('.js-btn-details');\n    const btnGrade = row.querySelector('.js-btn-grade');\n\n    if (status === 'processing' && progress > 0 && progress < 100) {\n        row.classList.add('js-row-inprogress');\n        if (!indicator) {\n            indicator = document.createElement('div');\n            indicator.className = 'small text-warning js-progress-indicator';\n            indicator.innerHTML = '<span class=\"spinner-border spinner-border-sm me-1\" role=\"status\" aria-hidden=\"true\"></span>';\n            row.querySelector('td:nth-child(7)')?.appendChild(indicator);\n        }\n        getString('processing', 'local_assign_ai').then(txt => {\n            indicator.innerHTML = '<span class=\"spinner-border spinner-border-sm me-1\" role=\"status\" aria-hidden=\"true\"></span>' + txt + ' (' + progress + '%)';\n        }).catch(() => {});\n\n        // Disable row action buttons while in progress.\n        row.querySelectorAll('button').forEach(b => b.setAttribute('disabled', 'disabled'));\n        setLinkDisabled(btnGrade, true);\n    } else {\n        row.classList.remove('js-row-inprogress');\n        if (indicator) {\n            indicator.remove();\n        }\n        // Re-enable row buttons depending on status.\n        if (status === 'initial') {\n            row.querySelectorAll('.js-review-ai').forEach(b => b.removeAttribute('disabled'));\n            setLinkDisabled(btnGrade, false);\n        } else if (status === 'pending') {\n            row.querySelectorAll('.view-details').forEach(b => b.removeAttribute('disabled'));\n            setLinkDisabled(btnGrade, false);\n        } else if (status === 'queued') {\n            // Keep disabled while waiting for processing to start.\n            row.querySelectorAll('button').forEach(b => b.setAttribute('disabled', 'disabled'));\n            setLinkDisabled(btnGrade, true);\n        } else {\n            row.querySelectorAll('button').forEach(b => b.removeAttribute('disabled'));\n            setLinkDisabled(btnGrade, false);\n        }\n    }\n\n    if (badge && hint) {\n        // Update badge class and short text per status, and the longer hint below.\n        if (status === 'initial') {\n            badge.className = 'badge bg-secondary js-state-badge';\n            getString('aistatus_initial_short', 'local_assign_ai').then(t => { badge.textContent = t; }).catch(() => {});\n            getString('aistatus_initial_help', 'local_assign_ai').then(t => { hint.textContent = t; }).catch(() => {});\n        } else if (status === 'queued') {\n            badge.className = 'badge bg-warning js-state-badge';\n            getString('aistatus_queued_short', 'local_assign_ai').then(t => { badge.textContent = t; }).catch(() => {});\n            getString('aistatus_queued_help', 'local_assign_ai').then(t => { hint.textContent = t; }).catch(() => {});\n        } else if (status === 'processing') {\n            badge.className = 'badge bg-warning js-state-badge';\n            getString('processing', 'local_assign_ai').then(t => { badge.textContent = t; }).catch(() => {});\n            getString('aistatus_processing_help', 'local_assign_ai').then(t => { hint.textContent = t; }).catch(() => {});\n        } else if (status === 'pending') {\n            badge.className = 'badge bg-info js-state-badge';\n            getString('aistatus_pending_short', 'local_assign_ai').then(t => { badge.textContent = t; }).catch(() => {});\n            getString('aistatus_pending_help', 'local_assign_ai').then(t => { hint.textContent = t; }).catch(() => {});\n        }\n    }\n\n    // Toggle visibility of action buttons based on status.\n    if (btnReview && btnDetails) {\n        if (status === 'pending' || progress >= 100) {\n            btnReview.classList.add('d-none');\n            btnDetails.classList.remove('d-none');\n        } else if (status === 'initial' || status === 'queued' || status === 'processing') {\n            btnDetails.classList.add('d-none');\n            btnReview.classList.remove('d-none');\n        }\n    }\n}\n\n/**\n * Find pending ids in the table that need updates.\n * @returns {number[]}\n */\nfunction collectPendingIds() {\n    const rows = document.querySelectorAll('tr[data-pendingid]');\n    const ids = [];\n    rows.forEach(row => {\n        const pid = parseInt(row.getAttribute('data-pendingid'), 10);\n        if (!pid) {\n            return;\n        }\n        const status = (row.getAttribute('data-status') || '').toLowerCase();\n        const isProcessing = status === 'processing';\n        const isQueued = status === 'queued';\n        const fallbackProcessing = !status && row.classList.contains('js-row-inprogress');\n        const fallbackQueued = !status && row.classList.contains('js-row-queued');\n        if (isProcessing || isQueued || fallbackProcessing || fallbackQueued) {\n            ids.push(pid);\n        }\n    });\n    return ids;\n}\n\n/**\n * Apply returned progress values to DOM.\n * @param {Array} entries\n */\nfunction applyProgress(entries) {\n    const now = Date.now();\n    entries.forEach(entry => {\n        const row = document.querySelector('tr[data-pendingid=\"' + entry.id + '\"]');\n        if (!row) {\n            return;\n        }\n        // Initialize smoothing when processing begins and it's not tracked.\n        if (entry.status === 'processing') {\n            if (!startTimes.has(entry.id)) {\n                startTimes.set(entry.id, now);\n                // Randomize expected duration 20-55s.\n                const expected = 20000 + Math.floor(Math.random() * 35001);\n                expectedDurations.set(entry.id, expected);\n                // Randomize starting offset 1-8% to avoid uniform starts.\n                startOffsets.set(entry.id, 1 + Math.floor(Math.random() * 8));\n                // Randomize easing curve factor for diversity (ease-out exponent).\n                curveFactors.set(entry.id, 0.6 + Math.random() * 0.8); // 0.6..1.4\n                // Initialize last shown.\n                lastShown.set(entry.id, 0);\n            }\n        }\n\n        // Compute adjusted client-side progress.\n        let adjusted = 0;\n        if (entry.status === 'processing' && startTimes.has(entry.id)) {\n            const startedAt = startTimes.get(entry.id);\n            const expected = expectedDurations.get(entry.id) || 35000;\n            const elapsed = Math.max(0, now - startedAt);\n            const t = Math.min(0.999, Math.max(0, elapsed / expected));\n            const start = startOffsets.get(entry.id) || 1;\n            const curve = curveFactors.get(entry.id) || 1.0;\n            // Ease-out with variable exponent to diversify curves.\n            const eased = 1 - Math.pow(1 - t, curve);\n            let estimated = start + Math.floor(eased * (99 - start));\n            // Add small, bounded per-tick noise to avoid perfectly smooth growth.\n            const noise = Math.floor((Math.random() * 5) - 2); // -2..+2\n            estimated = Math.max(start, Math.min(99, estimated + noise));\n            // Ensure monotonic increase.\n            const last = lastShown.get(entry.id) || 0;\n            adjusted = Math.max(last, estimated);\n            lastShown.set(entry.id, adjusted);\n        }\n\n        // If status is no longer processing, clear smoothing state.\n        if (entry.status !== 'processing') {\n            startTimes.delete(entry.id);\n            expectedDurations.delete(entry.id);\n            startOffsets.delete(entry.id);\n            curveFactors.delete(entry.id);\n            lastShown.delete(entry.id);\n        }\n\n        row.setAttribute('data-status', entry.status);\n        if (entry.status === 'queued') {\n            row.classList.add('js-row-queued');\n        } else {\n            row.classList.remove('js-row-queued');\n        }\n        row.setAttribute('data-progress', String(adjusted));\n        updateRow(row, adjusted, entry.status);\n    });\n\n    reflectHeaderButtonsState();\n}\n\nfunction stopPolling() {\n    if (intervalid) {\n        clearInterval(intervalid);\n        intervalid = 0;\n    }\n}\n\n/**\n * Poll backend for progress.\n * @returns {boolean}\n */\nfunction poll() {\n    const ids = collectPendingIds();\n    if (ids.length === 0) {\n        stopPolling();\n        reflectHeaderButtonsState();\n        return false;\n    }\n\n    Ajax.call([{\n        methodname: 'local_assign_ai_get_progress',\n        args: { pendingids: ids },\n    }])[0].done(result => {\n        applyProgress(result);\n    }).fail(err => {\n        Notification.exception(err);\n    });\n\n    return true;\n}\n\nfunction startPolling() {\n    if (intervalid) {\n        return;\n    }\n    if (!poll()) {\n        return;\n    }\n    intervalid = setInterval(poll, POLL_MS_DEFAULT);\n}\n\n/**\n * Init module.\n * @param {number} cmid\n */\nexport function init(cmid) {\n    // Initial reflect and start polling.\n    reflectHeaderButtonsState();\n    const initialDelay = document.body.classList.contains('assign-ai-progress-running') ? 0 : POLL_MS_DEFAULT;\n\n    document.addEventListener('click', (e) => {\n        const target = e.target.closest('a.js-btn-grade');\n        if (target && (target.classList.contains('disabled') || target.getAttribute('aria-disabled') === 'true')) {\n            e.preventDefault();\n            e.stopPropagation();\n        }\n    }, true);\n\n    if (hasActiveRows()) {\n        setTimeout(() => {\n            startPolling();\n        }, initialDelay);\n    }\n}\n\n/**\n * Public helper so other modules (e.g. review_with_ai) can force the poller to start.\n */\nexport function ensurePolling() {\n    startPolling();\n}\n"],"names":["startPolling","cmid","reflectHeaderButtonsState","initialDelay","document","body","classList","contains","addEventListener","e","target","closest","getAttribute","preventDefault","stopPropagation","hasActiveRows","setTimeout","intervalid","startTimes","Map","expectedDurations","startOffsets","curveFactors","lastShown","setLinkDisabled","link","disabled","add","setAttribute","remove","removeAttribute","querySelector","anyActive","btnReviewAll","btnApproveAll","dataset","enableonidle","applyProgress","entries","now","Date","forEach","entry","row","id","status","has","set","expected","Math","floor","random","adjusted","startedAt","get","elapsed","max","t","min","start","curve","eased","pow","estimated","noise","last","delete","String","progress","badge","hint","indicator","btnReview","btnDetails","btnGrade","createElement","className","innerHTML","appendChild","then","txt","catch","querySelectorAll","b","textContent","updateRow","poll","ids","rows","pid","parseInt","toLowerCase","isProcessing","isQueued","fallbackProcessing","fallbackQueued","push","collectPendingIds","length","clearInterval","call","methodname","args","pendingids","done","result","fail","err","exception","setInterval"],"mappings":"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"}