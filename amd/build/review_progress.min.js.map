{"version":3,"file":"review_progress.min.js","sources":["../src/review_progress.js"],"sourcesContent":["/* eslint-disable */\n// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Polls backend for progress of AI reviews and updates UI accordingly.\n *\n * @module     local_assign_ai/review_progress\n * @copyright  2025 Wilber Narvaez <https://datacurso.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport {get_string as getString} from 'core/str';\n\nconst POLL_MS_DEFAULT = 8000;\nlet intervalid = 0;\n\n/**\n * Disable/enable the header buttons depending on current progress state.\n */\nfunction reflectHeaderButtonsState() {\n    const anyInProgress = document.querySelector('tr.js-row-inprogress');\n    const btnReviewAll = document.querySelector('.js-review-all');\n    const btnApproveAll = document.querySelector('.js-approve-all');\n\n    if (btnReviewAll) {\n        btnReviewAll.disabled = !!anyInProgress || btnReviewAll.disabled;\n    }\n    if (btnApproveAll) {\n        if (anyInProgress) {\n            btnApproveAll.setAttribute('disabled', 'disabled');\n        } else if (btnApproveAll.dataset.enableonidle === '1') {\n            btnApproveAll.removeAttribute('disabled');\n        }\n    }\n}\n\n/**\n * Update a single row UI using progress info.\n * @param {HTMLElement} row\n * @param {number} progress\n * @param {string} status\n */\nfunction updateRow(row, progress, status) {\n    const badge = row.querySelector('.js-state-badge');\n    const hint = row.querySelector('.js-state-hint');\n    let indicator = row.querySelector('.js-progress-indicator');\n\n    if (progress > 0 && progress < 100) {\n        row.classList.add('js-row-inprogress');\n        if (!indicator) {\n            indicator = document.createElement('div');\n            indicator.className = 'small text-warning js-progress-indicator';\n            indicator.innerHTML = '<span class=\"spinner-border spinner-border-sm me-1\" role=\"status\" aria-hidden=\"true\"></span>';\n            row.querySelector('td:nth-child(7)')?.appendChild(indicator);\n        }\n        getString('processing', 'local_assign_ai').then(txt => {\n            indicator.innerHTML = '<span class=\"spinner-border spinner-border-sm me-1\" role=\"status\" aria-hidden=\"true\"></span>' + txt + ' (' + progress + '%)';\n        }).catch(() => {});\n\n        // Disable row action buttons while in progress.\n        row.querySelectorAll('button').forEach(b => b.setAttribute('disabled', 'disabled'));\n    } else {\n        row.classList.remove('js-row-inprogress');\n        if (indicator) {\n            indicator.remove();\n        }\n        // Re-enable row buttons depending on status.\n        if (status === 'initial') {\n            row.querySelectorAll('.js-review-ai').forEach(b => b.removeAttribute('disabled'));\n        } else if (status === 'pending') {\n            row.querySelectorAll('.view-details').forEach(b => b.removeAttribute('disabled'));\n        } else {\n            row.querySelectorAll('button').forEach(b => b.removeAttribute('disabled'));\n        }\n    }\n\n    if (badge && hint) {\n        if (status === 'initial') {\n            badge.className = 'badge bg-secondary js-state-badge';\n        } else if (status === 'pending') {\n            badge.className = 'badge bg-info js-state-badge';\n        }\n    }\n}\n\n/**\n * Find pending ids in the table that need updates.\n * @returns {number[]}\n */\nfunction collectPendingIds() {\n    const rows = document.querySelectorAll('tr[data-pendingid]');\n    const ids = [];\n    rows.forEach(row => {\n        const pid = parseInt(row.getAttribute('data-pendingid'), 10);\n        const progress = parseInt(row.getAttribute('data-progress') || '0', 10);\n        if (pid && progress < 100) {\n            ids.push(pid);\n        }\n    });\n    return ids;\n}\n\n/**\n * Apply returned progress values to DOM.\n * @param {Array} entries\n */\nfunction applyProgress(entries) {\n    entries.forEach(entry => {\n        const row = document.querySelector('tr[data-pendingid=\"' + entry.id + '\"]');\n        if (!row) {\n            return;\n        }\n        row.setAttribute('data-progress', String(entry.progress));\n        updateRow(row, entry.progress, entry.status);\n    });\n\n    reflectHeaderButtonsState();\n}\n\n/**\n * Poll backend for progress.\n */\nfunction poll() {\n    const ids = collectPendingIds();\n    if (ids.length === 0) {\n        clearInterval(intervalid);\n        reflectHeaderButtonsState();\n        return;\n    }\n\n    Ajax.call([{\n        methodname: 'local_assign_ai_get_progress',\n        args: { pendingids: ids },\n    }])[0].done(result => {\n        applyProgress(result);\n    }).fail(err => {\n        Notification.exception(err);\n    });\n}\n\n/**\n * Init module.\n * @param {number} cmid\n */\nexport function init(cmid) { // eslint-disable-line no-unused-vars\n    // Initial reflect and start polling.\n    reflectHeaderButtonsState();\n    // If page was just queued, ensure we start immediately.\n    const initialDelay = document.body.classList.contains('assign-ai-progress-running') ? 0 : POLL_MS_DEFAULT;\n    setTimeout(() => {\n        poll();\n        intervalid = setInterval(poll, POLL_MS_DEFAULT);\n    }, initialDelay);\n}\n"],"names":["cmid","reflectHeaderButtonsState","initialDelay","document","body","classList","contains","setTimeout","poll","intervalid","setInterval","anyInProgress","querySelector","btnReviewAll","btnApproveAll","disabled","setAttribute","dataset","enableonidle","removeAttribute","applyProgress","entries","forEach","entry","row","id","String","progress","status","badge","hint","indicator","add","createElement","className","innerHTML","appendChild","then","txt","catch","querySelectorAll","b","remove","updateRow","ids","rows","pid","parseInt","getAttribute","push","collectPendingIds","length","clearInterval","call","methodname","args","pendingids","done","result","fail","err","exception"],"mappings":";;;;;;;oFA8JqBA,MAEjBC,kCAEMC,aAAeC,SAASC,KAAKC,UAAUC,SAAS,8BAAgC,EAvIlE,IAwIpBC,YAAW,KACPC,OACAC,WAAaC,YAAYF,KA1IT,OA2IjBN,2GA1IHO,WAAa,WAKRR,kCACCU,cAAgBR,SAASS,cAAc,wBACvCC,aAAeV,SAASS,cAAc,kBACtCE,cAAgBX,SAASS,cAAc,mBAEzCC,eACAA,aAAaE,WAAaJ,eAAiBE,aAAaE,UAExDD,gBACIH,cACAG,cAAcE,aAAa,WAAY,YACO,MAAvCF,cAAcG,QAAQC,cAC7BJ,cAAcK,gBAAgB,sBA2EjCC,cAAcC,SACnBA,QAAQC,SAAQC,cACNC,IAAMrB,SAASS,cAAc,sBAAwBW,MAAME,GAAK,MACjED,MAGLA,IAAIR,aAAa,gBAAiBU,OAAOH,MAAMI,oBAtEpCH,IAAKG,SAAUC,cACxBC,MAAQL,IAAIZ,cAAc,mBAC1BkB,KAAON,IAAIZ,cAAc,sBAC3BmB,UAAYP,IAAIZ,cAAc,6BAE9Be,SAAW,GAAKA,SAAW,IAAK,wBAChCH,IAAInB,UAAU2B,IAAI,qBACbD,YACDA,UAAY5B,SAAS8B,cAAc,OACnCF,UAAUG,UAAY,2CACtBH,UAAUI,UAAY,0HACtBX,IAAIZ,cAAc,qEAAoBwB,YAAYL,gCAE5C,aAAc,mBAAmBM,MAAKC,MAC5CP,UAAUI,UAAY,+FAAiGG,IAAM,KAAOX,SAAW,QAChJY,OAAM,SAGTf,IAAIgB,iBAAiB,UAAUlB,SAAQmB,GAAKA,EAAEzB,aAAa,WAAY,mBAEvEQ,IAAInB,UAAUqC,OAAO,qBACjBX,WACAA,UAAUW,SAGC,YAAXd,OACAJ,IAAIgB,iBAAiB,iBAAiBlB,SAAQmB,GAAKA,EAAEtB,gBAAgB,cACnD,YAAXS,OACPJ,IAAIgB,iBAAiB,iBAAiBlB,SAAQmB,GAAKA,EAAEtB,gBAAgB,cAErEK,IAAIgB,iBAAiB,UAAUlB,SAAQmB,GAAKA,EAAEtB,gBAAgB,cAIlEU,OAASC,OACM,YAAXF,OACAC,MAAMK,UAAY,oCACA,YAAXN,SACPC,MAAMK,UAAY,iCAiCtBS,CAAUnB,IAAKD,MAAMI,SAAUJ,MAAMK,YAGzC3B,qCAMKO,aACCoC,qBAjCAC,KAAO1C,SAASqC,iBAAiB,sBACjCI,IAAM,UACZC,KAAKvB,SAAQE,YACHsB,IAAMC,SAASvB,IAAIwB,aAAa,kBAAmB,IACnDrB,SAAWoB,SAASvB,IAAIwB,aAAa,kBAAoB,IAAK,IAChEF,KAAOnB,SAAW,KAClBiB,IAAIK,KAAKH,QAGVF,IAwBKM,MACO,IAAfN,IAAIO,cACJC,cAAc3C,iBACdR,0CAICoD,KAAK,CAAC,CACPC,WAAY,+BACZC,KAAM,CAAEC,WAAYZ,QACpB,GAAGa,MAAKC,SACRtC,cAAcsC,WACfC,MAAKC,4BACSC,UAAUD"}