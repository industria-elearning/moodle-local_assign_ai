{"version":3,"file":"review.min.js","sources":["../src/review.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Modal for reviewing AI-generated comments (Mustache-based).\n *\n * @module      local_assign_ai/review\n * @copyright   2025 Datacurso\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport { getTinyMCE } from 'editor_tiny/loader';\nimport * as TinyEditor from 'editor_tiny/editor';\nimport Templates from 'core/templates';\nimport { get_string as getString } from 'core/str';\n\nexport const init = () => {\n    document.querySelectorAll('.view-details').forEach(btn => {\n        btn.addEventListener('click', e => {\n            const courseid = parseInt(e.currentTarget.dataset.courseid, 10);\n            const cmid = parseInt(e.currentTarget.dataset.cmid, 10);\n            const userid = parseInt(e.currentTarget.dataset.userid, 10);\n\n            Ajax.call([{\n                methodname: 'local_assign_ai_get_details',\n                args: { courseid, cmid, userid }\n            }])[0].done(async data => {\n                // Load localized strings.\n                const [title, saveLabel, saveApproveLabel] = await Promise.all([\n                    getString('modaltitle', 'local_assign_ai'),\n                    getString('save', 'local_assign_ai'),\n                    getString('saveapprove', 'local_assign_ai'),\n                ]);\n\n                // Render Mustache template.\n                const bodyHtml = await Templates.render('local_assign_ai/review_modal', {\n                    message: data.message || '',\n                    courseid,\n                    cmid,\n                    userid,\n                    savelabel: saveLabel,\n                    saveapprovelabel: saveApproveLabel\n                });\n\n                // Create the modal.\n                const modal = await ModalFactory.create({\n                    type: ModalFactory.types.DEFAULT,\n                    title: title,\n                    body: bodyHtml,\n                    large: true,\n                });\n\n                modal.show();\n\n                const root = modal.getRoot();\n                const textarea = root.find('#airesponse-edit')[0];\n\n                // Initialize TinyMCE editor.\n                let tinymce;\n                try {\n                    tinymce = await getTinyMCE();\n                    const base = TinyEditor.getStandardConfig ? TinyEditor.getStandardConfig() : {};\n                    await tinymce.init({\n                        ...base,\n                        target: textarea,\n                        menubar: base.menubar ?? false,\n                        plugins: base.plugins ?? 'lists link table code',\n                        toolbar: base.toolbar ?? 'undo redo | bold italic underline | bullist numlist | link | removeformat | code',\n                    });\n                } catch (err) {\n                    // Fallback to plain textarea if TinyMCE is not available.\n                    // console.warn('TinyMCE not available:', err);\n                }\n\n                const getContent = () => {\n                    const inst = tinymce && tinymce.get(textarea.id);\n                    return inst ? inst.getContent() : textarea.value;\n                };\n\n                // Save action.\n                root.on('click', '.save-ai', e => {\n                    e.preventDefault();\n                    const newMessage = getContent();\n                    Ajax.call([{\n                        methodname: 'local_assign_ai_update_response',\n                        args: { courseid, cmid, userid, message: newMessage },\n                    }])[0].done(() => location.reload())\n                        .fail(Notification.exception);\n                });\n\n                // Save and approve action.\n                root.on('click', '.approve-ai', e => {\n                    e.preventDefault();\n                    const newMessage = getContent();\n                    Ajax.call([{\n                        methodname: 'local_assign_ai_update_response',\n                        args: { courseid, cmid, userid, message: newMessage },\n                    }])[0].done(() => {\n                        Ajax.call([{\n                            methodname: 'local_assign_ai_change_status',\n                            args: { courseid, cmid, userid, action: 'approve' },\n                        }])[0].done(() => location.reload())\n                            .fail(Notification.exception);\n                    }).fail(Notification.exception);\n                });\n\n                // Reject action.\n                root.on('click', '.reject-ai', e => {\n                    e.preventDefault();\n                    Ajax.call([{\n                        methodname: 'local_assign_ai_change_status',\n                        args: { courseid, cmid, userid, action: 'rejected' },\n                    }])[0].done(() => location.reload())\n                        .fail(Notification.exception);\n                });\n\n                // Destroy TinyMCE instance when modal is closed.\n                root.on(ModalEvents.hidden, () => {\n                    const inst = tinymce && tinymce.get(textarea.id);\n                    if (inst) { inst.remove(); }\n                });\n            }).fail(Notification.exception);\n        });\n    });\n\n    // Approve all pending items.\n    const approveAllBtn = document.querySelector('.js-approve-all');\n    if (approveAllBtn) {\n        approveAllBtn.addEventListener('click', async e => {\n            e.preventDefault();\n            const [confirmApproveAll, confirmTitle, continueLabel] = await Promise.all([\n                getString('confirm_approve_all', 'local_assign_ai'),\n                getString('confirm', 'moodle'),\n                getString('continue', 'moodle'),\n            ]);\n\n            const doApproveAll = () => {\n                approveAllBtn.disabled = true;\n                const originalHTML = approveAllBtn.innerHTML;\n                const spinnerHtml = '<span class=\"spinner-border spinner-border-sm me-2\" role=\"status\" aria-hidden=\"true\"></span>';\n                approveAllBtn.innerHTML = spinnerHtml + originalHTML;\n\n                const courseid = parseInt(approveAllBtn.dataset.courseid, 10);\n                const cmid = parseInt(approveAllBtn.dataset.cmid, 10);\n                Ajax.call([{\n                    methodname: 'local_assign_ai_approve_all_pending',\n                    args: { courseid, cmid },\n                }])[0]\n                    .done(() => window.location.reload())\n                    .fail(err => {\n                        Notification.exception(err);\n                        approveAllBtn.innerHTML = originalHTML;\n                        approveAllBtn.disabled = false;\n                    });\n            };\n\n            Notification.saveCancelPromise(\n                confirmTitle,\n                confirmApproveAll,\n                continueLabel,\n                {triggerElement: approveAllBtn}\n            ).then(doApproveAll).catch(() => {});\n        });\n    }\n};\n"],"names":["document","querySelectorAll","forEach","btn","addEventListener","e","courseid","parseInt","currentTarget","dataset","cmid","userid","call","methodname","args","done","async","title","saveLabel","saveApproveLabel","Promise","all","bodyHtml","Templates","render","message","data","savelabel","saveapprovelabel","modal","ModalFactory","create","type","types","DEFAULT","body","large","show","root","getRoot","textarea","find","tinymce","base","TinyEditor","getStandardConfig","init","target","menubar","plugins","toolbar","err","getContent","inst","get","id","value","on","preventDefault","newMessage","location","reload","fail","Notification","exception","action","ModalEvents","hidden","remove","approveAllBtn","querySelector","confirmApproveAll","confirmTitle","continueLabel","saveCancelPromise","triggerElement","then","disabled","originalHTML","innerHTML","window","catch"],"mappings":"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"}