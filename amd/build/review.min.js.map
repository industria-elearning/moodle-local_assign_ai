{"version":3,"file":"review.min.js","sources":["../src/review.js"],"sourcesContent":["import ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\n\n// üëâ Tiny en Moodle\nimport { getTinyMCE } from 'editor_tiny/loader';\nimport * as TinyEditor from 'editor_tiny/editor';\n\nexport const init = () => {\n    document.querySelectorAll('.view-details').forEach(btn => {\n        btn.addEventListener('click', e => {\n            const token = e.currentTarget.dataset.token;\n\n            Ajax.call([{\n                methodname: 'local_assign_ai_get_details',\n                args: { token }\n            }])[0].done(async data => {\n                const modal = await ModalFactory.create({\n                    type: ModalFactory.types.DEFAULT,\n                    title: 'Retroalimentaci√≥n AI',\n                    body: `\n            <textarea id=\"airesponse-edit\" class=\"form-control\" rows=\"8\">${data.message || ''}</textarea>\n            <div class=\"mt-2\">\n              <button class=\"btn btn-success save-ai\" data-token=\"${token}\">Guardar</button>\n              <button class=\"btn btn-primary approve-ai\" data-token=\"${token}\">Guardar y Aprobar</button>\n              <button class=\"btn btn-danger reject-ai\" data-token=\"${token}\">Rechazar</button>\n            </div>\n          `,\n                    large: true,\n                });\n\n                modal.show();\n\n                const root = modal.getRoot();\n                const textarea = root.find('#airesponse-edit')[0];\n\n                // üîπ Inicializa Tiny en el textarea (con fallback si falla)\n                let tinymce;\n                try {\n                    tinymce = await getTinyMCE();\n                    const base = TinyEditor.getStandardConfig ? TinyEditor.getStandardConfig() : {};\n                    await tinymce.init({\n                        ...base,\n                        target: textarea,\n                        menubar: base.menubar ?? false,\n                        plugins: base.plugins ?? 'lists link table code',\n                        toolbar: base.toolbar ?? 'undo redo | bold italic underline | bullist numlist | link | removeformat | code',\n                    });\n                } catch (err) {\n                    // Fallback silencioso al textarea normal\n                    // console.warn('Tiny no disponible:', err);\n                }\n\n                const getContent = () => {\n                    const inst = tinymce && tinymce.get(textarea.id);\n                    return inst ? inst.getContent() : textarea.value;\n                };\n\n                // Guardar\n                root.on('click', '.save-ai', e => {\n                    e.preventDefault();\n                    const newMessage = getContent();\n                    Ajax.call([{\n                        methodname: 'local_assign_ai_update_response',\n                        args: { token, message: newMessage },\n                    }])[0].done(() => location.reload())\n                        .fail(Notification.exception);\n                });\n\n                // Guardar y aprobar\n                root.on('click', '.approve-ai', e => {\n                    e.preventDefault();\n                    const newMessage = getContent();\n                    Ajax.call([{\n                        methodname: 'local_assign_ai_update_response',\n                        args: { token, message: newMessage },\n                    }])[0].done(() => {\n                        Ajax.call([{\n                            methodname: 'local_assign_ai_change_status',\n                            args: { token, action: 'approve' },\n                        }])[0].done(() => location.reload())\n                            .fail(Notification.exception);\n                    }).fail(Notification.exception);\n                });\n\n                // Rechazar\n                root.on('click', '.reject-ai', e => {\n                    e.preventDefault();\n                    Ajax.call([{\n                        methodname: 'local_assign_ai_change_status',\n                        args: { token, action: 'rejected' },\n                    }])[0].done(() => location.reload())\n                        .fail(Notification.exception);\n                });\n\n                // üßπ Limpieza: destruye la instancia al cerrar el modal\n                root.on(ModalEvents.hidden, () => {\n                    const inst = tinymce && tinymce.get(textarea.id);\n                    if (inst) { inst.remove(); }\n                });\n            }).fail(Notification.exception);\n        });\n    });\n};\n"],"names":["document","querySelectorAll","forEach","btn","addEventListener","e","token","currentTarget","dataset","call","methodname","args","done","async","modal","ModalFactory","create","type","types","DEFAULT","title","body","data","message","large","show","root","getRoot","textarea","find","tinymce","base","TinyEditor","getStandardConfig","init","target","menubar","plugins","toolbar","err","getContent","inst","get","id","value","on","preventDefault","newMessage","location","reload","fail","Notification","exception","action","ModalEvents","hidden","remove"],"mappings":"6hDASoB,KAChBA,SAASC,iBAAiB,iBAAiBC,SAAQC,MAC/CA,IAAIC,iBAAiB,SAASC,UACpBC,MAAQD,EAAEE,cAAcC,QAAQF,oBAEjCG,KAAK,CAAC,CACPC,WAAY,8BACZC,KAAM,CAAEL,MAAAA,UACR,GAAGM,MAAKC,MAAAA,aACFC,YAAcC,uBAAaC,OAAO,CACpCC,KAAMF,uBAAaG,MAAMC,QACzBC,MAAO,uBACPC,0FACuDC,KAAKC,SAAW,6HAEvBjB,0GACGA,kHACFA,6DAGjDkB,OAAO,IAGXV,MAAMW,aAEAC,KAAOZ,MAAMa,UACbC,SAAWF,KAAKG,KAAK,oBAAoB,OAG3CC,0DAEAA,cAAgB,8BACVC,KAAOC,WAAWC,kBAAoBD,WAAWC,oBAAsB,SACvEH,QAAQI,KAAK,IACZH,KACHI,OAAQP,SACRQ,8BAASL,KAAKK,gDACdC,8BAASN,KAAKM,+CAAW,wBACzBC,8BAASP,KAAKO,+CAAW,qFAE/B,MAAOC,YAKHC,WAAa,WACTC,KAAOX,SAAWA,QAAQY,IAAId,SAASe,WACtCF,KAAOA,KAAKD,aAAeZ,SAASgB,OAI/ClB,KAAKmB,GAAG,QAAS,YAAYxC,IACzBA,EAAEyC,uBACIC,WAAaP,2BACd/B,KAAK,CAAC,CACPC,WAAY,kCACZC,KAAM,CAAEL,MAAAA,MAAOiB,QAASwB,eACxB,GAAGnC,MAAK,IAAMoC,SAASC,WACtBC,KAAKC,sBAAaC,cAI3B1B,KAAKmB,GAAG,QAAS,eAAexC,IAC5BA,EAAEyC,uBACIC,WAAaP,2BACd/B,KAAK,CAAC,CACPC,WAAY,kCACZC,KAAM,CAAEL,MAAAA,MAAOiB,QAASwB,eACxB,GAAGnC,MAAK,mBACHH,KAAK,CAAC,CACPC,WAAY,gCACZC,KAAM,CAAEL,MAAAA,MAAO+C,OAAQ,cACvB,GAAGzC,MAAK,IAAMoC,SAASC,WACtBC,KAAKC,sBAAaC,cACxBF,KAAKC,sBAAaC,cAIzB1B,KAAKmB,GAAG,QAAS,cAAcxC,IAC3BA,EAAEyC,+BACGrC,KAAK,CAAC,CACPC,WAAY,gCACZC,KAAM,CAAEL,MAAAA,MAAO+C,OAAQ,eACvB,GAAGzC,MAAK,IAAMoC,SAASC,WACtBC,KAAKC,sBAAaC,cAI3B1B,KAAKmB,GAAGS,sBAAYC,QAAQ,WAClBd,KAAOX,SAAWA,QAAQY,IAAId,SAASe,IACzCF,MAAQA,KAAKe,eAEtBN,KAAKC,sBAAaC"}