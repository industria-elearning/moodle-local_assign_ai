{"version":3,"file":"review.min.js","sources":["../src/review.js"],"sourcesContent":["import ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport { getTinyMCE } from 'editor_tiny/loader';\nimport * as TinyEditor from 'editor_tiny/editor';\nimport { get_string as getString } from 'core/str';\n\nexport const init = () => {\n    document.querySelectorAll('.view-details').forEach(btn => {\n        btn.addEventListener('click', e => {\n            const token = e.currentTarget.dataset.token;\n\n            Ajax.call([{\n                methodname: 'local_assign_ai_get_details',\n                args: { token }\n            }])[0].done(async data => {\n                const [title, saveLabel, saveApproveLabel] = await Promise.all([\n                    getString('modaltitle', 'local_assign_ai'),\n                    getString('save', 'local_assign_ai'),\n                    getString('saveapprove', 'local_assign_ai'),\n                ]);\n\n                const modal = await ModalFactory.create({\n                    type: ModalFactory.types.DEFAULT,\n                    title: title,\n                    body: `\n            <textarea id=\"airesponse-edit\" class=\"form-control\" rows=\"8\">${data.message || ''}</textarea>\n            <div class=\"mt-2\">\n              <button class=\"btn btn-success save-ai\" data-token=\"${token}\">${saveLabel}</button>\n              <button class=\"btn btn-primary approve-ai\" data-token=\"${token}\">${saveApproveLabel}</button>\n            </div>\n          `,\n                    large: true,\n                });\n\n                modal.show();\n\n                const root = modal.getRoot();\n                const textarea = root.find('#airesponse-edit')[0];\n\n                let tinymce;\n                try {\n                    tinymce = await getTinyMCE();\n                    const base = TinyEditor.getStandardConfig ? TinyEditor.getStandardConfig() : {};\n                    await tinymce.init({\n                        ...base,\n                        target: textarea,\n                        menubar: base.menubar ?? false,\n                        plugins: base.plugins ?? 'lists link table code',\n                        toolbar: base.toolbar ?? 'undo redo | bold italic underline | bullist numlist | link | removeformat | code',\n                    });\n                } catch (err) {\n                    // Silent fallback to normal textarea\n                    // console.warn('Tiny not available:', err);\n                }\n\n                const getContent = () => {\n                    const inst = tinymce && tinymce.get(textarea.id);\n                    return inst ? inst.getContent() : textarea.value;\n                };\n\n                // Save\n                root.on('click', '.save-ai', e => {\n                    e.preventDefault();\n                    const newMessage = getContent();\n                    Ajax.call([{\n                        methodname: 'local_assign_ai_update_response',\n                        args: { token, message: newMessage },\n                    }])[0].done(() => location.reload())\n                        .fail(Notification.exception);\n                });\n\n                // Save and approve\n                root.on('click', '.approve-ai', e => {\n                    e.preventDefault();\n                    const newMessage = getContent();\n                    Ajax.call([{\n                        methodname: 'local_assign_ai_update_response',\n                        args: { token, message: newMessage },\n                    }])[0].done(() => {\n                        Ajax.call([{\n                            methodname: 'local_assign_ai_change_status',\n                            args: { token, action: 'approve' },\n                        }])[0].done(() => location.reload())\n                            .fail(Notification.exception);\n                    }).fail(Notification.exception);\n                });\n\n                // Reject\n                root.on('click', '.reject-ai', e => {\n                    e.preventDefault();\n                    Ajax.call([{\n                        methodname: 'local_assign_ai_change_status',\n                        args: { token, action: 'rejected' },\n                    }])[0].done(() => location.reload())\n                        .fail(Notification.exception);\n                });\n\n                // Destroy TinyMCE instance when modal closes\n                root.on(ModalEvents.hidden, () => {\n                    const inst = tinymce && tinymce.get(textarea.id);\n                    if (inst) { inst.remove(); }\n                });\n            }).fail(Notification.exception);\n        });\n    });\n};\n"],"names":["document","querySelectorAll","forEach","btn","addEventListener","e","token","currentTarget","dataset","call","methodname","args","done","async","title","saveLabel","saveApproveLabel","Promise","all","modal","ModalFactory","create","type","types","DEFAULT","body","data","message","large","show","root","getRoot","textarea","find","tinymce","base","TinyEditor","getStandardConfig","init","target","menubar","plugins","toolbar","err","getContent","inst","get","id","value","on","preventDefault","newMessage","location","reload","fail","Notification","exception","action","ModalEvents","hidden","remove"],"mappings":"6iDAQoB,KAChBA,SAASC,iBAAiB,iBAAiBC,SAAQC,MAC/CA,IAAIC,iBAAiB,SAASC,UACpBC,MAAQD,EAAEE,cAAcC,QAAQF,oBAEjCG,KAAK,CAAC,CACPC,WAAY,8BACZC,KAAM,CAAEL,MAAAA,UACR,GAAGM,MAAKC,MAAAA,aACDC,MAAOC,UAAWC,wBAA0BC,QAAQC,IAAI,EAC3D,mBAAU,aAAc,oBACxB,mBAAU,OAAQ,oBAClB,mBAAU,cAAe,qBAGvBC,YAAcC,uBAAaC,OAAO,CACpCC,KAAMF,uBAAaG,MAAMC,QACzBV,MAAOA,MACPW,0FACuDC,KAAKC,SAAW,6HAEvBrB,mBAAUS,qGACPT,mBAAUU,8DAG7DY,OAAO,IAGXT,MAAMU,aAEAC,KAAOX,MAAMY,UACbC,SAAWF,KAAKG,KAAK,oBAAoB,OAE3CC,0DAEAA,cAAgB,8BACVC,KAAOC,WAAWC,kBAAoBD,WAAWC,oBAAsB,SACvEH,QAAQI,KAAK,IACZH,KACHI,OAAQP,SACRQ,8BAASL,KAAKK,gDACdC,8BAASN,KAAKM,+CAAW,wBACzBC,8BAASP,KAAKO,+CAAW,qFAE/B,MAAOC,YAKHC,WAAa,WACTC,KAAOX,SAAWA,QAAQY,IAAId,SAASe,WACtCF,KAAOA,KAAKD,aAAeZ,SAASgB,OAI/ClB,KAAKmB,GAAG,QAAS,YAAY5C,IACzBA,EAAE6C,uBACIC,WAAaP,2BACdnC,KAAK,CAAC,CACPC,WAAY,kCACZC,KAAM,CAAEL,MAAAA,MAAOqB,QAASwB,eACxB,GAAGvC,MAAK,IAAMwC,SAASC,WACtBC,KAAKC,sBAAaC,cAI3B1B,KAAKmB,GAAG,QAAS,eAAe5C,IAC5BA,EAAE6C,uBACIC,WAAaP,2BACdnC,KAAK,CAAC,CACPC,WAAY,kCACZC,KAAM,CAAEL,MAAAA,MAAOqB,QAASwB,eACxB,GAAGvC,MAAK,mBACHH,KAAK,CAAC,CACPC,WAAY,gCACZC,KAAM,CAAEL,MAAAA,MAAOmD,OAAQ,cACvB,GAAG7C,MAAK,IAAMwC,SAASC,WACtBC,KAAKC,sBAAaC,cACxBF,KAAKC,sBAAaC,cAIzB1B,KAAKmB,GAAG,QAAS,cAAc5C,IAC3BA,EAAE6C,+BACGzC,KAAK,CAAC,CACPC,WAAY,gCACZC,KAAM,CAAEL,MAAAA,MAAOmD,OAAQ,eACvB,GAAG7C,MAAK,IAAMwC,SAASC,WACtBC,KAAKC,sBAAaC,cAI3B1B,KAAKmB,GAAGS,sBAAYC,QAAQ,WAClBd,KAAOX,SAAWA,QAAQY,IAAId,SAASe,IACzCF,MAAQA,KAAKe,eAEtBN,KAAKC,sBAAaC"}