{"version":3,"file":"observer.min.js","sources":["../src/observer.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Observer to monitor grader page and trigger AI injection.\n *\n * @module     local_assign_ai/observer\n * @copyright   2025 Datacurso\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport * as InjectAI from 'local_assign_ai/inject_ai';\nimport Config from 'core/config';\n\n/**\n * Resolve the current grader userid from URL or DOM fallback.\n *\n * @returns {number}\n */\nconst resolveCurrentUserid = () => {\n    const params = new URLSearchParams(window.location.search);\n    let userid = parseInt(params.get('userid'), 10);\n\n    if (userid) {\n        return userid;\n    }\n\n    const userLink = document.querySelector('[data-region=\"user-info\"] a[href*=\"user/view.php\"]');\n    if (userLink) {\n        const url = new URL(userLink.href);\n        userid = parseInt(url.searchParams.get('id'), 10);\n        if (userid) {\n            return userid;\n        }\n    }\n\n    const input = document.querySelector('input[name=\"userid\"]');\n    if (input) {\n        userid = parseInt(input.value, 10);\n        if (userid) {\n            return userid;\n        }\n    }\n\n    return 0;\n};\n\n/**\n * Observes the grader page and starts injection for the active student.\n *\n * Handles grader navigation where `userid` changes in-place.\n *\n * @returns {Promise<void>}\n */\nexport const init = async () => {\n    const courseid = Config.courseId || Config.courseid;\n    if (!courseid) {\n        return;\n    }\n\n    let lastuserid = 0;\n    let lastassignmentid = 0;\n    let lasttoken = '';\n    let inflight = false;\n    let attempts = 0;\n    const maxAttempts = 240;\n\n    const syncCurrentUser = async () => {\n        if (inflight) {\n            return;\n        }\n\n        const params = new URLSearchParams(window.location.search);\n        const assignmentid = parseInt(params.get('id'), 10);\n        if (!assignmentid) {\n            return;\n        }\n\n        const userid = resolveCurrentUserid();\n        if (!userid) {\n            return;\n        }\n\n        inflight = true;\n        try {\n            const response = await Ajax.call([{\n                methodname: 'local_assign_ai_get_token',\n                args: { userid, assignmentid }\n            }])[0];\n\n            const token = response?.approval_token || '';\n            const contextChanged = userid !== lastuserid || assignmentid !== lastassignmentid;\n            const tokenChanged = token !== lasttoken;\n\n            if (contextChanged || tokenChanged) {\n                InjectAI.init({ token, userid, assignmentid, courseid });\n            }\n\n            lastuserid = userid;\n            lastassignmentid = assignmentid;\n            lasttoken = token;\n        } catch (err) {\n            Notification.exception(err);\n        } finally {\n            inflight = false;\n        }\n    };\n\n    await syncCurrentUser();\n\n    const interval = setInterval(() => {\n        attempts++;\n        if (attempts > maxAttempts) {\n            clearInterval(interval);\n            return;\n        }\n        void syncCurrentUser();\n    }, 500);\n};\n"],"names":["async","courseid","Config","courseId","lastuserid","lastassignmentid","lasttoken","inflight","attempts","syncCurrentUser","params","URLSearchParams","window","location","search","assignmentid","parseInt","get","userid","userLink","document","querySelector","url","URL","href","searchParams","input","value","resolveCurrentUserid","response","Ajax","call","methodname","args","token","approval_token","tokenChanged","InjectAI","init","err","exception","interval","setInterval","clearInterval"],"mappings":";;;;;;;g4BAoEoBA,gBACVC,SAAWC,gBAAOC,UAAYD,gBAAOD,aACtCA,oBAIDG,WAAa,EACbC,iBAAmB,EACnBC,UAAY,GACZC,UAAW,EACXC,SAAW,QAGTC,gBAAkBT,aAChBO,sBAIEG,OAAS,IAAIC,gBAAgBC,OAAOC,SAASC,QAC7CC,aAAeC,SAASN,OAAOO,IAAI,MAAO,QAC3CF,0BAICG,OA3De,YACnBR,OAAS,IAAIC,gBAAgBC,OAAOC,SAASC,YAC/CI,OAASF,SAASN,OAAOO,IAAI,UAAW,OAExCC,cACOA,aAGLC,SAAWC,SAASC,cAAc,yDACpCF,SAAU,OACJG,IAAM,IAAIC,IAAIJ,SAASK,SAC7BN,OAASF,SAASM,IAAIG,aAAaR,IAAI,MAAO,IAC1CC,cACOA,aAITQ,MAAQN,SAASC,cAAc,+BACjCK,QACAR,OAASF,SAASU,MAAMC,MAAO,IAC3BT,QACOA,OAIR,GAkCYU,MACVV,QAILX,UAAW,YAEDsB,eAAiBC,cAAKC,KAAK,CAAC,CAC9BC,WAAY,4BACZC,KAAM,CAAEf,OAAAA,OAAQH,aAAAA,iBAChB,GAEEmB,OAAQL,MAAAA,gBAAAA,SAAUM,iBAAkB,GAEpCC,aAAeF,QAAU5B,WADRY,SAAWd,YAAcW,eAAiBV,kBAG3C+B,eAClBC,SAASC,KAAK,CAAEJ,MAAAA,MAAOhB,OAAAA,OAAQH,aAAAA,aAAcd,SAAAA,WAGjDG,WAAac,OACbb,iBAAmBU,aACnBT,UAAY4B,MACd,MAAOK,2BACQC,UAAUD,aAEvBhC,UAAW,WAIbE,wBAEAgC,SAAWC,aAAY,KACzBlC,WACIA,SA/CY,IAgDZmC,cAAcF,UAGbhC,oBACN"}