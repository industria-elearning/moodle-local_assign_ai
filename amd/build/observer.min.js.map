{"version":3,"file":"observer.min.js","sources":["../src/observer.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Observer to monitor grader page and trigger AI injection.\n *\n * @module     local_assign_ai/observer\n * @copyright   2025 Datacurso\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport * as InjectAI from 'local_assign_ai/inject_ai';\nimport Config from 'core/config';\n\n/**\n * Observes the grader page, extracts URL parameters, retrieves\n * the AI approval token for the current student, and triggers\n * injection of AI-generated feedback into the grader interface.\n *\n * @returns {Promise<void>}\n */\nexport const init = async () => {\n\n    const params = new URLSearchParams(window.location.search);\n    const assignmentid = parseInt(params.get('id'));\n    const courseid = Config.courseId || Config.courseid;\n\n    if (!assignmentid || !courseid) {\n        return;\n    }\n\n    // Function to attempt initialization\n    const tryInit = async () => {\n        const currentParams = new URLSearchParams(window.location.search);\n        let userid = parseInt(currentParams.get('userid'));\n\n        // Fallback: Try to find userid from the DOM if not in URL\n        if (!userid) {\n            // Try Common Moodle Grader selectors\n            const userLink = document.querySelector('[data-region=\"user-info\"] a[href*=\"user/view.php\"]');\n            if (userLink) {\n                const url = new URL(userLink.href);\n                userid = parseInt(url.searchParams.get('id'));\n            } else {\n                const input = document.querySelector('input[name=\"userid\"]');\n                if (input) {\n                    userid = parseInt(input.value);\n                }\n            }\n        }\n\n        if (userid) {\n            try {\n                const response = await Ajax.call([{\n                    methodname: 'local_assign_ai_get_token',\n                    args: { userid, assignmentid }\n                }])[0];\n\n                if (response?.approval_token) {\n                    InjectAI.init({\n                        token: response.approval_token,\n                        userid,\n                        assignmentid,\n                        courseid\n                    });\n                    return true; // Success\n                }\n            } catch (err) {\n                Notification.exception(err);\n                return true; // Stop polling on error\n            }\n        }\n        return false; // Not ready yet\n    };\n\n    // Attempt immediately\n    if (await tryInit()) {\n        return;\n    }\n\n    // Retry via polling if userid wasn't found immediately (e.g. first load)\n    let attempts = 0;\n    const maxAttempts = 20; // Wait up to ~10s\n    const interval = setInterval(async () => {\n        attempts++;\n        if (await tryInit() || attempts >= maxAttempts) {\n            clearInterval(interval);\n        }\n    }, 500);\n};\n"],"names":["async","params","URLSearchParams","window","location","search","assignmentid","parseInt","get","courseid","Config","courseId","tryInit","currentParams","userid","userLink","document","querySelector","url","URL","href","searchParams","input","value","response","Ajax","call","methodname","args","approval_token","InjectAI","init","token","err","exception","attempts","interval","setInterval","clearInterval"],"mappings":";;;;;;;g4BAmCoBA,gBAEVC,OAAS,IAAIC,gBAAgBC,OAAOC,SAASC,QAC7CC,aAAeC,SAASN,OAAOO,IAAI,OACnCC,SAAWC,gBAAOC,UAAYD,gBAAOD,aAEtCH,eAAiBG,sBAKhBG,QAAUZ,gBACNa,cAAgB,IAAIX,gBAAgBC,OAAOC,SAASC,YACtDS,OAASP,SAASM,cAAcL,IAAI,eAGnCM,OAAQ,OAEHC,SAAWC,SAASC,cAAc,yDACpCF,SAAU,OACJG,IAAM,IAAIC,IAAIJ,SAASK,MAC7BN,OAASP,SAASW,IAAIG,aAAab,IAAI,WACpC,OACGc,MAAQN,SAASC,cAAc,wBACjCK,QACAR,OAASP,SAASe,MAAMC,YAKhCT,iBAEUU,eAAiBC,cAAKC,KAAK,CAAC,CAC9BC,WAAY,4BACZC,KAAM,CAAEd,OAAAA,OAAQR,aAAAA,iBAChB,MAEAkB,MAAAA,UAAAA,SAAUK,sBACVC,SAASC,KAAK,CACVC,MAAOR,SAASK,eAChBf,OAAAA,OACAR,aAAAA,aACAG,SAAAA,YAEG,EAEb,MAAOwB,kCACQC,UAAUD,MAChB,SAGR,YAIDrB,qBAKNuB,SAAW,QAETC,SAAWC,aAAYrC,UACzBmC,kBACUvB,WAAauB,UAHP,KAIZG,cAAcF,YAEnB"}