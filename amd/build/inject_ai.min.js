define("local_assign_ai/inject_ai",["exports","core/ajax","core/notification"],(function(_exports,_ajax,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification);_exports.init=token=>{token&&_ajax.default.call([{methodname:"local_assign_ai_get_details",args:{token:token}}])[0].done((data=>{const message=data.message,rubricResponse=data.rubric_response,grade=data.grade;let attempts=0;const interval=setInterval((()=>{attempts++;const messageInjected=(()=>{const textarea=document.querySelector('#id_assignfeedbackcomments_editor, textarea[id^="id_feedbackcomments_"]');if(!textarea)return!1;if(textarea.value=message,window.tinymce&&window.tinymce.get(textarea.id))return window.tinymce.get(textarea.id).setContent(message),!0;if(window.M&&window.M.editor_atto&&window.M.editor_atto.getEditorForElement){const editor=window.M.editor_atto.getEditorForElement(textarea);if(editor)return editor.setHTML(message),!0}return!1})(),rubricInjected=(()=>{if(!rubricResponse)return!1;let rubricData;try{rubricData="string"==typeof rubricResponse?JSON.parse(rubricResponse):rubricResponse}catch(e){return _notification.default.addNotification({message:"Error parsing rubric_response: "+e.message,type:"error"}),!1}if(!Array.isArray(rubricData))return _notification.default.addNotification({message:"rubric_response debe ser un array",type:"error"}),!1;let injected=!1;const normalizeString=str=>str.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim();return rubricData.forEach((criterionData=>{const criterionName=criterionData.criterion,targetPoints=criterionData.levels[0].points,comment=criterionData.levels[0].comment;document.querySelectorAll("tr.criterion").forEach((row=>{const descriptionCell=row.querySelector("td.description");if(!descriptionCell)return;const rowCriterionName=descriptionCell.textContent.trim();if(normalizeString(rowCriterionName)===normalizeString(criterionName)){const levelCells=row.querySelectorAll("td.level");levelCells.forEach((levelCell=>{const scoreSpan=levelCell.querySelector(".scorevalue");if(scoreSpan&&parseInt(scoreSpan.textContent.trim())===targetPoints){const radioInput=levelCell.querySelector('input[type="radio"]');radioInput&&(radioInput.checked=!0,levelCell.setAttribute("aria-checked","true"),levelCells.forEach((otherCell=>{otherCell!==levelCell&&otherCell.setAttribute("aria-checked","false")})),injected=!0)}}));const remarkTextarea=row.querySelector("td.remark textarea");remarkTextarea&&comment&&(remarkTextarea.value=comment,injected=!0)}}))})),injected})(),gradeInjected=(()=>{if(rubricResponse||!grade)return!1;const gradeInput=document.querySelector('#id_grade, input[name="grade"]');if(!gradeInput)return!1;gradeInput.value=grade;const event=new Event("change",{bubbles:!0});return gradeInput.dispatchEvent(event),!0})();(messageInjected||rubricInjected||gradeInjected||attempts>20)&&(clearInterval(interval),rubricInjected?_notification.default.addNotification({message:"Rúbrica inyectada exitosamente",type:"success"}):gradeInjected?_notification.default.addNotification({message:"Calificación inyectada exitosamente",type:"success"}):attempts>20&&_notification.default.addNotification({message:"No se pudo inyectar la rúbrica después de 20 intentos",type:"warning"}))}),500)})).fail(_notification.default.exception)}}));

//# sourceMappingURL=inject_ai.min.js.map