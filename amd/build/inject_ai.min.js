define("local_assign_ai/inject_ai",["exports","core/ajax","core/notification","core/str"],(function(_exports,_ajax,_notification,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Insert comments, rubric, and AI-generated rating into the task evaluation form.
   *
   * @module      local_assign_ai/inject_ai
   * @copyright   2025 Datacurso
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_notification=_interopRequireDefault(_notification);_exports.init=async _ref=>{let{token:token,userid:userid,assignmentid:assignmentid,courseid:courseid}=_ref;if(!(token&&userid&&assignmentid&&courseid))return void _notification.default.addNotification({message:"[AI DEBUG] ParÃ¡metros insuficientes para get_details.",type:"error"});const[strErrorParsing,strRubricArray,strRubricSuccess,strRubricFailed]=await Promise.all([(0,_str.get_string)("errorparsingrubric","local_assign_ai"),(0,_str.get_string)("rubricmustarray","local_assign_ai"),(0,_str.get_string)("rubricsuccess","local_assign_ai"),(0,_str.get_string)("rubricfailed","local_assign_ai")]);_ajax.default.call([{methodname:"local_assign_ai_get_details",args:{courseid:courseid,cmid:assignmentid,userid:userid}}])[0].done((data=>{var _ref2,_data$message,_ref3,_data$rubric_response,_data$grade;const message=null!==(_ref2=null!==(_data$message=data.message)&&void 0!==_data$message?_data$message:data.reply)&&void 0!==_ref2?_ref2:"",rubricResponse=null!==(_ref3=null!==(_data$rubric_response=data.rubric_response)&&void 0!==_data$rubric_response?_data$rubric_response:data.rubric)&&void 0!==_ref3?_ref3:null,grade=null!==(_data$grade=data.grade)&&void 0!==_data$grade?_data$grade:null,injectMessage=()=>{const textarea=document.querySelector('#id_assignfeedbackcomments_editor, textarea[id^="id_feedbackcomments_"]');if(!textarea)return!1;if(textarea.value=message,window.tinymce&&window.tinymce.get(textarea.id))return window.tinymce.get(textarea.id).setContent(message),!0;if(window.M&&window.M.editor_atto&&window.M.editor_atto.getEditorForElement){const editor=window.M.editor_atto.getEditorForElement(textarea);if(editor)return editor.setHTML(message),!0}return textarea.value===message},injectRubric=()=>{if(!rubricResponse)return!1;let rubricData;try{rubricData="string"==typeof rubricResponse?JSON.parse(rubricResponse):rubricResponse}catch(e){return _notification.default.addNotification({message:"".concat(strErrorParsing," ").concat(e.message),type:"error"}),!1}if(!Array.isArray(rubricData))return _notification.default.addNotification({message:strRubricArray,type:"error"}),!1;let injected=!1;const normalizeString=str=>str.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim(),criterionRows=document.querySelectorAll("tr.criterion");return 0!==criterionRows.length&&(rubricData.forEach((criterionData=>{const criterionName=criterionData.criterion,targetPoints=criterionData.levels[0].points,comment=criterionData.levels[0].comment;criterionRows.forEach((row=>{const descriptionCell=row.querySelector("td.description");if(!descriptionCell)return;const rowCriterionName=descriptionCell.textContent.trim();if(normalizeString(rowCriterionName)!==normalizeString(criterionName))return;const levelCells=row.querySelectorAll("td.level");levelCells.forEach((levelCell=>{const scoreSpan=levelCell.querySelector(".scorevalue");if(!scoreSpan)return;if(parseInt(scoreSpan.textContent.trim(),10)===targetPoints){const radioInput=levelCell.querySelector('input[type="radio"]');if(!radioInput)return;levelCell.click&&levelCell.click(),radioInput.click&&radioInput.click(),setTimeout((()=>{radioInput.checked=!0,radioInput.dispatchEvent&&(radioInput.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window})),radioInput.dispatchEvent(new Event("change",{bubbles:!0}))),levelCell.setAttribute("aria-checked","true"),levelCells.forEach((otherCell=>{if(otherCell!==levelCell){otherCell.setAttribute("aria-checked","false");const otherRadio=otherCell.querySelector('input[type="radio"]');otherRadio&&(otherRadio.checked=!1)}}))}),50),injected=!0}}));const remarkTextarea=row.querySelector("td.remark textarea");remarkTextarea&&comment&&(remarkTextarea.value=comment,remarkTextarea.dispatchEvent(new Event("input",{bubbles:!0})),remarkTextarea.dispatchEvent(new Event("change",{bubbles:!0})),injected=!0)}))})),injected)},injectSimpleGrade=()=>{if(rubricResponse||!grade)return!1;const input=document.querySelector('#id_grade, input[name="grade"]');return!!input&&(input.value=grade,input.dispatchEvent(new Event("change",{bubbles:!0})),!0)};let successfulInjection=!1,attempts=0;const interval=setInterval((()=>{if(attempts++,!successfulInjection){injectMessage();const r=injectRubric(),g=injectSimpleGrade();(r||g)&&(successfulInjection=!0)}var success;(successfulInjection&&attempts>12||attempts>50)&&(clearInterval(interval),success=successfulInjection,_notification.default.addNotification({message:success?strRubricSuccess:strRubricFailed,type:success?"success":"warning"}))}),300),rubricContainer=document.querySelector(".gradingform_rubric")||document.querySelector("#page-content")||document.body;if(rubricContainer){const observer=new MutationObserver((()=>{if(document.querySelectorAll("tr.criterion").length>0&&!successfulInjection){injectMessage();const rubricInjected=injectRubric(),gradeInjected=injectSimpleGrade();(rubricInjected||gradeInjected)&&(successfulInjection=!0,observer.disconnect())}}));observer.observe(rubricContainer,{childList:!0,subtree:!0}),setTimeout((()=>observer.disconnect()),15e3)}})).fail(_notification.default.exception)}}));

//# sourceMappingURL=inject_ai.min.js.map