{"version":3,"file":"inject_ai.min.js","sources":["../src/inject_ai.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Insert comments, rubric, and AI-generated rating into the task evaluation form.\n *\n * @module      local_assign_ai/inject_ai\n * @copyright   2025 Datacurso\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport { get_string as getString } from 'core/str';\n\n/**\n * Injects AI-generated feedback, rubric selections and/or grade\n * into the assignment grading form for the current student.\n *\n * @param {Object} params                      Required parameters.\n * @param {string} params.token                Approval token used to fetch AI details.\n * @param {number} params.userid               ID of the student being graded.\n * @param {number} params.assignmentid         Assignment identifier (cmid) from the grader URL.\n * @param {number} params.courseid             Course ID of the assignment.\n */\nexport const init = async ({ token, userid, assignmentid, courseid }) => {\n\n    if (!token || !userid || !assignmentid || !courseid) {\n        return;\n    }\n\n    // Preload language strings\n    const [\n        strErrorParsing,\n        strRubricArray,\n        strRubricSuccess,\n        strRubricFailed\n    ] = await Promise.all([\n        getString('errorparsingrubric', 'local_assign_ai'),\n        getString('rubricmustarray', 'local_assign_ai'),\n        getString('rubricsuccess', 'local_assign_ai'),\n        getString('rubricfailed', 'local_assign_ai'),\n    ]);\n\n    // Retrieve AI-generated feedback details.\n    Ajax.call([{\n        methodname: 'local_assign_ai_get_details',\n        args: {\n            courseid,\n            cmid: assignmentid,\n            userid\n        }\n    }])[0]\n        .done(data => {\n\n            const message = data.message ?? data.reply ?? '';\n            const rubricResponse = data.rubric_response ?? data.rubric ?? null;\n            const grade = data.grade ?? null;\n\n            /**\n             * Injects AI message into feedback editor.\n             * @returns {boolean} True if message was injected successfully\n             */\n            const injectMessage = () => {\n                const textarea = document.querySelector(\n                    '#id_assignfeedbackcomments_editor, textarea[id^=\"id_feedbackcomments_\"]'\n                );\n\n                if (!textarea) {\n                    return false;\n                }\n                textarea.value = message;\n\n                // TinyMCE support\n                if (window.tinymce && window.tinymce.get(textarea.id)) {\n                    window.tinymce.get(textarea.id).setContent(message);\n                    return true;\n                }\n\n                // Atto support\n                if (window.M && window.M.editor_atto && window.M.editor_atto.getEditorForElement) {\n                    const editor = window.M.editor_atto.getEditorForElement(textarea);\n                    if (editor) {\n                        editor.setHTML(message);\n                        return true;\n                    }\n                }\n\n                return textarea.value === message;\n            };\n\n            /**\n             * Injects rubric selections and comments.\n             * @returns {boolean} True if rubric was injected successfully\n             */\n            const injectRubric = () => {\n                // Check if rubricResponse is null, undefined, empty string, or 'null' string\n                if (!rubricResponse || rubricResponse === 'null' || rubricResponse === '') {\n                    return false;\n                }\n\n                let rubricData;\n                try {\n                    rubricData = typeof rubricResponse === 'string'\n                        ? JSON.parse(rubricResponse)\n                        : rubricResponse;\n                } catch (e) {\n                    Notification.addNotification({\n                        message: `${strErrorParsing} ${e.message}`,\n                        type: 'error'\n                    });\n                    return false;\n                }\n\n                if (!Array.isArray(rubricData)) {\n                    Notification.addNotification({\n                        message: strRubricArray,\n                        type: 'error'\n                    });\n                    return false;\n                }\n\n                let injected = false;\n\n                const normalizeString = str =>\n                    str.normalize('NFD')\n                        .replace(/[\\u0300-\\u036f]/g, '')\n                        .toLowerCase()\n                        .trim();\n\n                const criterionRows = document.querySelectorAll('tr.criterion');\n\n                if (criterionRows.length === 0) {\n                    return false;\n                }\n\n                rubricData.forEach((criterionData) => {\n\n                    const criterionName = criterionData.criterion;\n                    const targetPoints = criterionData.levels[0].points;\n                    const comment = criterionData.levels[0].comment;\n\n                    criterionRows.forEach((row) => {\n                        const descriptionCell = row.querySelector('td.description');\n                        if (!descriptionCell) {\n                            return;\n                        }\n\n                        const rowCriterionName = descriptionCell.textContent.trim();\n                        if (normalizeString(rowCriterionName) !== normalizeString(criterionName)) {\n                            return;\n                        }\n\n                        const levelCells = row.querySelectorAll('td.level');\n                        levelCells.forEach((levelCell) => {\n\n                            const scoreSpan = levelCell.querySelector('.scorevalue');\n                            if (!scoreSpan) {\n                                return;\n                            }\n\n                            const points = parseInt(scoreSpan.textContent.trim(), 10);\n\n                            if (points === targetPoints) {\n\n                                const radioInput = levelCell.querySelector('input[type=\"radio\"]');\n                                if (!radioInput) {\n                                    return;\n                                }\n\n                                // Simulate user click\n                                if (levelCell.click) {\n                                    levelCell.click();\n                                }\n\n                                if (radioInput.click) {\n                                    radioInput.click();\n                                }\n\n                                setTimeout(() => {\n                                    radioInput.checked = true;\n\n                                    if (radioInput.dispatchEvent) {\n                                        radioInput.dispatchEvent(new MouseEvent('click', {\n                                            bubbles: true,\n                                            cancelable: true,\n                                            view: window\n                                        }));\n                                        radioInput.dispatchEvent(new Event('change', { bubbles: true }));\n                                    }\n\n                                    levelCell.setAttribute('aria-checked', 'true');\n                                    levelCells.forEach(otherCell => {\n                                        if (otherCell !== levelCell) {\n                                            otherCell.setAttribute('aria-checked', 'false');\n                                            const otherRadio = otherCell.querySelector('input[type=\"radio\"]');\n                                            if (otherRadio) {\n                                                otherRadio.checked = false;\n                                            }\n                                        }\n                                    });\n\n                                }, 50);\n\n                                injected = true;\n                            }\n                        });\n\n                        const remarkTextarea = row.querySelector('td.remark textarea');\n                        if (remarkTextarea && comment) {\n                            remarkTextarea.value = comment;\n                            remarkTextarea.dispatchEvent(new Event('input', { bubbles: true }));\n                            remarkTextarea.dispatchEvent(new Event('change', { bubbles: true }));\n                            injected = true;\n                        }\n\n                    });\n\n                });\n\n                return injected;\n            };\n\n            /**\n             * Injects simple numeric grade.\n             * @returns {boolean} True if grade was injected successfully\n             */\n            const injectSimpleGrade = () => {\n                // Only inject simple grade if there's no rubric data AND grade exists\n                if (rubricResponse && rubricResponse !== 'null' && rubricResponse !== '') {\n                    return false;\n                }\n\n                if (!grade) {\n                    return false;\n                }\n\n                const input = document.querySelector('#id_grade, input[name=\"grade\"]');\n                if (!input) {\n                    return false;\n                }\n                input.value = grade;\n                input.dispatchEvent(new Event('change', { bubbles: true }));\n\n                return true;\n            };\n\n            /**\n             * Shows injection results to user.\n             * @param {boolean} success Whether injection was successful\n             */\n            const showResults = (success) => {\n                Notification.addNotification({\n                    message: success ? strRubricSuccess : strRubricFailed,\n                    type: success ? 'success' : 'warning'\n                });\n            };\n\n            // Injection state\n            let successfulInjection = false;\n            let attempts = 0;\n            const maxAttempts = 50;\n\n            const interval = setInterval(() => {\n                attempts++;\n\n                if (!successfulInjection) {\n                    injectMessage();\n                    const r = injectRubric();\n                    const g = injectSimpleGrade();\n\n                    if (r || g) {\n                        successfulInjection = true;\n                    }\n                }\n\n                if ((successfulInjection && attempts > 12) || attempts > maxAttempts) {\n                    clearInterval(interval);\n                    showResults(successfulInjection);\n                }\n            }, 300);\n\n            const rubricContainer = document.querySelector('.gradingform_rubric') ||\n                document.querySelector('#page-content') ||\n                document.body;\n\n            if (rubricContainer) {\n                const observer = new MutationObserver(() => {\n                    const criterionRows = document.querySelectorAll('tr.criterion');\n\n                    if (criterionRows.length > 0 && !successfulInjection) {\n                        injectMessage();\n                        const rubricInjected = injectRubric();\n                        const gradeInjected = injectSimpleGrade();\n\n                        if (rubricInjected || gradeInjected) {\n                            successfulInjection = true;\n                            observer.disconnect();\n                        }\n                    }\n                });\n\n                observer.observe(rubricContainer, {\n                    childList: true,\n                    subtree: true\n                });\n\n                setTimeout(() => observer.disconnect(), 15000);\n            }\n\n        })\n        .fail(Notification.exception);\n};\n"],"names":["async","token","userid","assignmentid","courseid","strErrorParsing","strRubricArray","strRubricSuccess","strRubricFailed","Promise","all","call","methodname","args","cmid","done","data","message","reply","rubricResponse","rubric_response","rubric","grade","injectMessage","textarea","document","querySelector","value","window","tinymce","get","id","setContent","M","editor_atto","getEditorForElement","editor","setHTML","injectRubric","rubricData","JSON","parse","e","addNotification","type","Array","isArray","injected","normalizeString","str","normalize","replace","toLowerCase","trim","criterionRows","querySelectorAll","length","forEach","criterionData","criterionName","criterion","targetPoints","levels","points","comment","row","descriptionCell","rowCriterionName","textContent","levelCells","levelCell","scoreSpan","parseInt","radioInput","click","setTimeout","checked","dispatchEvent","MouseEvent","bubbles","cancelable","view","Event","setAttribute","otherCell","otherRadio","remarkTextarea","injectSimpleGrade","input","successfulInjection","attempts","interval","setInterval","r","g","success","clearInterval","rubricContainer","body","observer","MutationObserver","rubricInjected","gradeInjected","disconnect","observe","childList","subtree","fail","Notification","exception"],"mappings":"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"}