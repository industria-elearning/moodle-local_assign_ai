{"version":3,"file":"review_with_ai.min.js","sources":["../src/review_with_ai.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Handles the \"Review with AI\" actions on the assignment review page.\n *\n * @module      local_assign_ai/review_with_ai\n * @copyright   2025 Datacurso\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\nimport { get_string as getString } from 'core/str';\n\n/**\n * Initialize event listeners for AI review buttons.\n */\nexport const init = async () => {\n    // Load localized strings\n    const [\n        strProcessing,\n        strQueued,\n        strProcessed,\n        strNoSubmissions,\n        strReload,\n        strError,\n        strConfirmReviewAll,\n        strConfirmTitle,\n        strContinue,\n    ] = await Promise.all([\n        getString('processing', 'local_assign_ai'),\n        getString('queued', 'local_assign_ai'),\n        getString('processed', 'local_assign_ai'),\n        getString('nosubmissions', 'local_assign_ai'),\n        getString('reloadpage', 'local_assign_ai'),\n        getString('processingerror', 'local_assign_ai'),\n        getString('confirm_review_all', 'local_assign_ai'),\n        getString('confirm', 'moodle'),\n        getString('continue', 'moodle'),\n    ]);\n\n    document.querySelectorAll('.js-review-ai').forEach(button => {\n        button.addEventListener('click', e => {\n            e.preventDefault();\n\n            const cmid = parseInt(button.dataset.cmid);\n            const userid = parseInt(button.dataset.userid || 0);\n            const pendingid = button.dataset.pendingid ? parseInt(button.dataset.pendingid, 10) : 0;\n            const all = button.dataset.all === '1';\n\n            const processRequest = () => {\n                // Save the original HTML to restore it later\n                const originalHTML = button.innerHTML;\n\n                // Show spinner with text\n                button.innerHTML = `\n                    <span class=\"spinner-border spinner-border-sm me-2\" role=\"status\" aria-hidden=\"true\"></span>\n                    ${strProcessing}\n                `;\n                button.disabled = true;\n\n                // AJAX call to the web service\n                Ajax.call([{\n                    methodname: 'local_assign_ai_process_submission',\n                    args: { cmid: cmid, userid: userid, all: all, pendingid: pendingid },\n                }])[0].done(result => {\n                    if (result.status === 'queued') {\n                        Notification.addNotification({\n                            message: strQueued,\n                            type: 'info',\n                        });\n                        button.innerHTML = originalHTML;\n                        // Keep the bulk button disabled while progress polling runs.\n                        if (all) {\n                            button.disabled = true;\n                            // Soft trigger: add a body class so the progress module (if present) may start earlier.\n                            document.body.classList.add('assign-ai-progress-running');\n\n                            // Immediately reflect UI as queued for all rows in this CM.\n                            const rows = document.querySelectorAll('tr[data-cmid=\"' + cmid + '\"]');\n                            rows.forEach(row => {\n                                // Badge short label.\n                                const badge = row.querySelector('.js-state-badge');\n                                if (badge) {\n                                    badge.className = 'badge bg-warning text-dark js-state-badge';\n                                    badge.textContent = strQueued; // Short text.\n                                }\n                                // Longer hint under badge.\n                                const hint = row.querySelector('.js-state-hint');\n                                if (hint) {\n                                    getString('aistatus_queued_help', 'local_assign_ai').then(txt => {\n                                        hint.textContent = txt;\n                                    }).catch(() => {});\n                                }\n                                // Disable all row actions while queued.\n                                row.querySelectorAll('button').forEach(b => b.setAttribute('disabled', 'disabled'));\n                                // Ensure review/details visibility is consistent: hide details while not pending.\n                                const btnDetails = row.querySelector('.js-btn-details');\n                                if (btnDetails) {\n                                    btnDetails.classList.add('d-none');\n                                }\n                            });\n\n                            // Optionally trigger an immediate poll tick if the progress module is loaded.\n                            try {\n                                window.dispatchEvent(new CustomEvent('local_assign_ai:progress:start', {detail: {cmid}}));\n                            } catch (e) {}\n                        } else {\n                            button.disabled = false;\n                        }\n                        return;\n                    }\n\n                    if (result.status === 'ok') {\n                        Notification.addNotification({\n                            message: `${strProcessed.replace('{$a}', result.processed)} ${strReload}`,\n                            type: 'success',\n                        });\n                        window.location.reload();\n                        return;\n                    }\n\n                    Notification.addNotification({\n                        message: strNoSubmissions,\n                        type: 'warning',\n                    });\n                    button.innerHTML = originalHTML;\n                    button.disabled = false;\n                }).fail(err => {\n                    Notification.addNotification({\n                        message: strError,\n                        type: 'error',\n                    });\n                    Notification.exception(err);\n                    button.innerHTML = originalHTML;\n                    button.disabled = false;\n                });\n            };\n\n            if (all) {\n                Notification.saveCancelPromise(\n                    strConfirmTitle,\n                    strConfirmReviewAll,\n                    strContinue,\n                    {triggerElement: button}\n                ).then(processRequest).catch(() => {});\n                return;\n            }\n\n            processRequest();\n        });\n    });\n};\n"],"names":["async","strProcessing","strQueued","strProcessed","strNoSubmissions","strReload","strError","strConfirmReviewAll","strConfirmTitle","strContinue","Promise","all","document","querySelectorAll","forEach","button","addEventListener","e","preventDefault","cmid","parseInt","dataset","userid","pendingid","processRequest","originalHTML","innerHTML","disabled","call","methodname","args","done","result","status","addNotification","message","replace","processed","type","window","location","reload","body","classList","add","row","badge","querySelector","className","textContent","hint","then","txt","catch","b","setAttribute","btnDetails","dispatchEvent","CustomEvent","detail","fail","err","exception","saveCancelPromise","triggerElement"],"mappings":";;;;;;;wLA8BoBA,gBAGZC,cACAC,UACAC,aACAC,iBACAC,UACAC,SACAC,oBACAC,gBACAC,mBACMC,QAAQC,IAAI,EAClB,mBAAU,aAAc,oBACxB,mBAAU,SAAU,oBACpB,mBAAU,YAAa,oBACvB,mBAAU,gBAAiB,oBAC3B,mBAAU,aAAc,oBACxB,mBAAU,kBAAmB,oBAC7B,mBAAU,qBAAsB,oBAChC,mBAAU,UAAW,WACrB,mBAAU,WAAY,YAG1BC,SAASC,iBAAiB,iBAAiBC,SAAQC,SAC/CA,OAAOC,iBAAiB,SAASC,IAC7BA,EAAEC,uBAEIC,KAAOC,SAASL,OAAOM,QAAQF,MAC/BG,OAASF,SAASL,OAAOM,QAAQC,QAAU,GAC3CC,UAAYR,OAAOM,QAAQE,UAAYH,SAASL,OAAOM,QAAQE,UAAW,IAAM,EAChFZ,IAA6B,MAAvBI,OAAOM,QAAQV,IAErBa,eAAiB,WAEbC,aAAeV,OAAOW,UAG5BX,OAAOW,4JAEDzB,oCAENc,OAAOY,UAAW,gBAGbC,KAAK,CAAC,CACPC,WAAY,qCACZC,KAAM,CAAEX,KAAMA,KAAMG,OAAQA,OAAQX,IAAKA,IAAKY,UAAWA,cACzD,GAAGQ,MAAKC,YACc,WAAlBA,OAAOC,WA+CW,OAAlBD,OAAOC,oCACMC,gBAAgB,CACzBC,kBAAYhC,aAAaiC,QAAQ,OAAQJ,OAAOK,uBAAchC,WAC9DiC,KAAM,iBAEVC,OAAOC,SAASC,+BAIPP,gBAAgB,CACzBC,QAAS/B,iBACTkC,KAAM,YAEVvB,OAAOW,UAAYD,aACnBV,OAAOY,UAAW,gCA5DDO,gBAAgB,CACzBC,QAASjC,UACToC,KAAM,SAEVvB,OAAOW,UAAYD,aAEfd,IAAK,CACLI,OAAOY,UAAW,EAElBf,SAAS8B,KAAKC,UAAUC,IAAI,8BAGfhC,SAASC,iBAAiB,iBAAmBM,KAAO,MAC5DL,SAAQ+B,YAEHC,MAAQD,IAAIE,cAAc,mBAC5BD,QACAA,MAAME,UAAY,4CAClBF,MAAMG,YAAc/C,iBAGlBgD,KAAOL,IAAIE,cAAc,kBAC3BG,0BACU,uBAAwB,mBAAmBC,MAAKC,MACtDF,KAAKD,YAAcG,OACpBC,OAAM,SAGbR,IAAIhC,iBAAiB,UAAUC,SAAQwC,GAAKA,EAAEC,aAAa,WAAY,oBAEjEC,WAAaX,IAAIE,cAAc,mBACjCS,YACAA,WAAWb,UAAUC,IAAI,iBAM7BL,OAAOkB,cAAc,IAAIC,YAAY,iCAAkC,CAACC,OAAQ,CAACxC,KAAAA,SACnF,MAAOF,UAETF,OAAOY,UAAW,KAoB3BiC,MAAKC,4BACS3B,gBAAgB,CACzBC,QAAS7B,SACTgC,KAAM,gCAEGwB,UAAUD,KACvB9C,OAAOW,UAAYD,aACnBV,OAAOY,UAAW,MAItBhB,0BACaoD,kBACTvD,gBACAD,oBACAE,YACA,CAACuD,eAAgBjD,SACnBoC,KAAK3B,gBAAgB6B,OAAM,SAIjC7B"}